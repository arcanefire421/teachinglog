<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📘 教學日誌生成器 (v13.1 - 穩定版)</title>
<style>
/* 確保手機相容性及美觀 (CSS) */
body { font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:#f5f7fb;margin:0;padding:12px;color:#222;max-width:520px;margin-left:auto;margin-right:auto;}
h1{text-align:center;font-size:1.5rem;margin:12px 0 14px 0;}
.card{background:#fff;border-radius:12px;padding:12px 10px;margin-bottom:12px;
  box-shadow:0 2px 8px rgba(0,20,50,0.06);}
label{font-weight:600;display:block;margin-top:6px;margin-bottom:2px;}
input,select,textarea{width:100%;padding:8px;border-radius:8px;font-size:1rem;
  border:1px solid #ccc;box-sizing:border-box;margin-top:2px;}
textarea{resize:vertical;font-size:1rem;}
button{background:#2563eb;color:white;border:none;border-radius:8px;padding:9px 12px;
  margin-top:8px;cursor:pointer;font-weight:bold;font-size:1rem;margin-right:6px;}
button.danger{background:#ef4444;}button.green{background:#22c55e;}button.orange{background:#f59e0b;}
.section{border-top:1px solid #e5e7eb;margin-top:8px;padding-top:8px;}
.chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;
  margin:4px 3px 3px 0;background:#eef3fc;font-size:0.93rem;cursor:pointer;}
.chip:hover{background:#e2e8f0;}
.output{font-family:"Noto Sans Mono","Consolas",monospace;border-radius:8px;
  line-height:1.6;background:#fff;border:1px solid #e5e7eb;padding:14px 12px;margin-top:10px;
  font-size:1.05rem;white-space:pre-wrap;letter-spacing:0.012em;}
@media (max-width:520px){
  body{padding:4px;}
  .output{font-size:1.09rem;padding:8px 6px;}
  input,select,textarea{font-size:1.01rem;}
}
.select-group {
    display: flex;
    gap: 5px;
}
.select-group select {
    width: 33.33%;
    margin-top: 0;
}
.select-group + input {
    margin-top: 5px;
}
.button-row {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.button-row button {
    margin-top: 0;
    margin-right: 0;
    flex-grow: 1;
    width: auto;
}
.unit-row{
  display: flex;
  align-items: flex-start;
  margin-top: 5px;
  line-height: 1.2;
}
.unit-row input[type=checkbox]{
  width: auto;
  margin: 2px 5px 0 0;
  transform: scale(1.1);
  flex-shrink: 0;
}
.unit-label{
  flex: 1;
  display: inline;
  margin-top: 0;
}
#progressCache {
    margin-top: 10px;
    border: 1px dashed #2563eb;
    background: #f0f7ff;
    padding: 10px;
    border-radius: 8px;
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.95rem;
}
#progressCache .cache-item {
    margin-bottom: 5px;
    color: #1e40af;
    line-height: 1.3;
}
</style>
</head>
<body>
<h1>📘 教學日誌生成器 (v13.1 - 穩定版)</h1>

<div class="card">
  <label>🏫 班級模板</label>
  <div class="select-group">
    <select id="gradeSelect">
      <option>高一</option>
      <option>高二</option>
      <option>高三</option>
    </select>
    <select id="subjectSelect">
      <option>物理</option>
      <option>化學</option>
      <option>生物</option>
      <option>地科</option>
    </select>
    <select id="classTypeSelect">
      <option>進度</option>
      <option>總複習</option>
    </select>
  </div>
  <input id="customClassName" placeholder="或自訂班級名稱（可空白）">
  <button class="green" onclick="addTemplate()">＋新增模板</button>
  <button onclick="fillTemplate()">填入班名</button>
  <button class="danger" onclick="clearTemplates(true)">全清模板</button>
  <div id="templateList" style="margin-top:5px;"></div>
</div>

<div class="card">
  <label>🗓️ 日期</label>
  <div style="display:flex;gap:7px;flex-wrap:wrap;">
    <input id="dateInput" placeholder="自動今日">
    <button onclick="setToday()">今天</button>
    <button onclick="setTomorrow()">明天</button>
  </div>
</div>

<div class="card">
  <label>📚 科目 / 進度選單</label>
  <select id="subject" onchange="loadBooks()">
    <option value="">--選科目--</option>
    <option value="physics">物理</option>
    <option value="chemistry">化學</option>
    <option value="biology">生物</option>
    <option value="earth">地科</option>
  </select>

  <div id="bookArea" class="section">
  </div>

  <div id="cacheArea" class="section" style="text-align: center;">
      <button class="orange" onclick="addToCache()">➡️ 存入暫存區</button>
      <button class="danger" onclick="clearCache(true)">🗑️ 清空暫存</button>
  </div>

  <label style="margin-top: 10px;">💾 已選進度暫存區</label>
  <div id="progressCache">目前無暫存進度。</div>
</div>

<div class="card">
  <label>📚 課程資料產生器</label>
  <p style="font-size:0.9rem; margin-top:0; color:#555;">
    請貼上用 <b>Tab鍵</b> 縮排的課程文字。<b>最上層必須是「冊別」名稱。</b><br>
    產生後，請手動複製內容並貼到 <code>data.js</code> 檔案中。
  </p>
  <textarea id="importTextArea" rows="8" placeholder="選修物理 ( I )
	第1章 測量與不確定度
		1-1 不確定度與有效數字
			真值與不確定度(選修)
	第2章 運動學－直線運動
		2-1 位置、路徑長與位移
			位置與坐標軸(選修)" style="font-family:monospace;"></textarea>
  <button class="green" onclick="parseTextToJSON()">產生 data.js 內容</button>

  <div id="exportArea" class="section" style="display:none;">
    <label>✅ 產生的 JavaScript 內容</label>
    <textarea id="exportTextArea" rows="10" readonly style="background:#f9f9f9; color:#333; font-family:monospace;"></textarea>
  </div>
</div>

<div class="card">
  <div class="section">
    <label>📄 頁數</label>
    <input id="pages" placeholder="例：p.45~52">
    <div style="display:flex;gap:5px;flex-wrap:wrap;">
      <span class="chip" onclick="appendPages('p. ')">p. </span>
      <span class="chip" onclick="appendPages('p. 5~8')">p. 5~8</span>
      <span class="chip" onclick="appendPages('p. 10~15')">p. 10~15</span>
      <span class="chip" onclick="appendPages('p. 25~30')">p. 25~30</span>
      <span class="chip" onclick="appendPages('p. 50~55')">p. 50~55</span>
    </div>
  </div>
  <div class="section">
    <label>🧾 小考</label>
    <input id="quiz" placeholder="例：第2章小考">
  </div>
  <div class="section">
    <label>🏠 回家作業</label>
    <textarea id="homework" rows="2" placeholder="例：講義 p.53~55＋習題"></textarea>
    <div id="sentenceChips"></div>
    <input id="newSentence" placeholder="加到常用作業句庫（右鍵刪）">
    <button class="green" onclick="addSentence()">＋句庫</button>
  </div>
</div>

<div class="card">
  <div class="button-row">
    <button class="orange" onclick="generate()">🚀 產生</button>
    <button onclick="copyOutput()">📋 複製</button>
    <button class="danger" onclick="clearAll(true)">🧹 清空</button>
  </div>
  <div id="output" class="output" style="display:none"></div>
</div>

<script src="data.js"></script>

<script>
// ================ JS 變數與輔助函數 (v13.1 修正) ================

/**
 * [v13 修正] 新增：安全地從 localStorage 讀取 JSON 資料
 * @param {string} key - localStorage 的 key
 * @param {any} defaultValue - 如果解析失敗時的預設值
 * @returns {any} 解析後的物件或預設值
 */
function safeJSONParse(key, defaultValue) {
    try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
    } catch (e) {
        console.warn(`localStorage 資料 '${key}' 損毀，已重設。`, e);
        localStorage.removeItem(key); // 清除損毀的資料
        return defaultValue;
    }
}

// [v13 修正] 使用 safeJSONParse 來初始化，避免網頁因
let progressCache = safeJSONParse('teachingLogCache', []);
let templates = safeJSONParse('teachingLogTemplates', []);
let sentences = safeJSONParse('homeworkSentences', ["講義 p.X~Y", "習題卷", "考卷訂正", "複習指定範圍"]);


function saveCache() {
    localStorage.setItem('teachingLogCache', JSON.stringify(progressCache));
    renderCache();
}

function renderCache() {
    const cacheDiv = document.getElementById('progressCache');
    if (!cacheDiv) return; // 安全檢查
    if (progressCache.length === 0) {
        cacheDiv.innerHTML = '目前無暫存進度。';
        return;
    }
    const groupedCache = new Map();
    progressCache.forEach(item => {
        const path = item.path;
        if (groupedCache.has(path)) {
            if (!groupedCache.get(path).includes(item.topic)) {
                 groupedCache.get(path).push(item.topic);
            }
        } else {
            groupedCache.set(path, [item.topic]);
        }
    });

    let html = '';
    groupedCache.forEach((topics, path) => {
        const combinedTopics = topics.join(' ＋ ');
        const pathParts = path.split(' / ');
        const lastPart = pathParts.slice(-1)[0];
        const isPathOnly = topics.length === 1 && topics[0] === lastPart;
        
        if (isPathOnly) {
             html += `<div class="cache-item">‧ ${path}</div>`;
        } else {
             html += `<div class="cache-item">‧ ${path} <br> (${combinedTopics})</div>`;
        }
    });
    cacheDiv.innerHTML = html;
}

// ================ 課程資料產生器 (Parser) 函數 ================
function parseTextToJSON() {
    const text = document.getElementById('importTextArea').value;
    const lines = text.split('\n');
    let bookData = {};
    let currentBook = null;
    let currentChapter = null;
    let currentSection = null;

    const exportAreaDiv = document.getElementById('exportArea');
    const exportTextArea = document.getElementById('exportTextArea');

    try {
        if (text.trim() === "") {
            throw new Error("輸入框是空的。");
        }
        for (const rawLine of lines) {
            let line = rawLine;
            if (line.trim() === "") continue; 
            let indentLevel = 0;
            while (line.startsWith('\t')) {
                line = line.substring(1);
                indentLevel++;
            }
            line = line.trim();
            if (line === "") continue;

            switch (indentLevel) {
                case 0: // Level 1 - 冊別
                    currentBook = line;
                    bookData[currentBook] = {};
                    currentChapter = null;
                    currentSection = null;
                    break;
                case 1: // Level 2 - 章節
                    if (!currentBook) throw new Error(`[格式錯誤] 發現「章節」但尚未定義「冊別」：${line}`);
                    currentChapter = line;
                    bookData[currentBook][currentChapter] = {};
                    currentSection = null;
                    break;
                case 2: // Level 3 - 小節
                    if (!currentChapter) throw new Error(`[格式錯誤] 發現「小節」但尚未定義「章節」：${line}`);
                    currentSection = line;
                    bookData[currentBook][currentChapter][currentSection] = [];
                    break;
                case 3: // Level 4 - 重點
                    if (!currentSection) throw new Error(`[格式錯誤] 發現「重點」但尚未定義「小節」：${line}`);
                    bookData[currentBook][currentChapter][currentSection].push(line);
                    break;
                default:
                    if (currentSection) {
                        bookData[currentBook][currentChapter][currentSection].push(line);
                    } else {
                        console.warn("忽略縮排格式錯誤的行：", line);
                    }
                    break;
            }
        }
        if (Object.keys(bookData).length === 0) {
             throw new Error("沒有偵測到任何有效的「冊別」資料。請確認最上層（無縮排）為冊別名稱。");
        }

        // 將JS物件轉換為格式化的 JSON 字串
        let outputJson = JSON.stringify(bookData, null, 2);
        
        // 移除最外層的 {} 並去除空白
        outputJson = outputJson.slice(1, -1).trim();

        const instructions = `/* 1. 複製下方「所有」文字內容。
 2. 打開您的 data.js 檔案。
 3. 找到您要添加/覆蓋的「科目」，例如 "physics": { ... }
 4. 將複製的內容貼到該科目的 { } 大括號 *內部*。

   例如，"physics": {
     "基礎物理(全)": { ... },  <-- (這是舊資料)
     
     (貼在這裡)
     "選修物理(I)": { ... }   <-- (這是新貼上的)

   }
 5. 注意：請確保「冊別」之間有逗號 ,
*/

`;
        exportTextArea.value = instructions + outputJson;
        exportAreaDiv.style.display = 'block';

    } catch (e) {
        exportTextArea.value = "轉換失敗：\n" + e.message + "\n\n請檢查您的縮排格式是否正確（必須使用 Tab 鍵，而非空白鍵）。";
        exportAreaDiv.style.display = 'block';
    }
}

// ================ 核心進度功能 ================
function addToCache() {
    let itemsToCache = [];
    const checks = document.querySelectorAll("#topicArea input[type=checkbox]:checked");

    if (checks.length > 0) {
        checks.forEach(cb => {
            const path = cb.value;
            const topic = cb.dataset.topicName;
            itemsToCache.push({ path: path, topic: topic });
            cb.checked = false; 
        });
        console.log(`已將 ${checks.length} 個勾選重點存入暫存區！`);
    } else {
        const subjectSelect = document.getElementById('subject');
        const subjectKey = subjectSelect ? subjectSelect.value : '';
        const subjectName = subjectSelect ? subjectSelect.options[subjectSelect.selectedIndex].text : '';
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const sectionSelect = document.getElementById('sectionSelect');

        const bookName = bookSelect ? bookSelect.value : '';
        const chapterName = chapterSelect ? chapterSelect.value : '';
        const sectionName = sectionSelect ? sectionSelect.value : '';

        let progressPath = '';
        let progressName = '';

        if (subjectKey) {
            if (sectionName) {
                progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
                progressName = sectionName;
            } else if (chapterName) {
                progressPath = `${bookName} / ${chapterName}`;
                progressName = chapterName;
            } else if (bookName) {
                progressPath = `${bookName}`;
                progressName = bookName;
            } else {
                if (typeof BOOKS !== 'undefined' && BOOKS[subjectKey]) {
                    Object.keys(BOOKS[subjectKey]).forEach(bName => {
                        itemsToCache.push({ path: bName, topic: subjectName });
                    });
                     if (itemsToCache.length > 0) {
                         console.log(`偵測到只選科目，已將 ${subjectName} 涉及的 ${itemsToCache.length} 個冊別作為進度存入暫存區！`);
                     }
                    itemsToCache.forEach(item => {
                        const isDuplicate = progressCache.some(p => p.path === item.path && p.topic === item.topic);
                        if (!isDuplicate) progressCache.push(item);
                    });
                    saveCache();
                    return;
                }
            }
        }
        if (progressPath && progressName) {
            itemsToCache.push({ path: progressPath, topic: progressName });
            console.log(`已將選單最高層級：${progressPath} 存入暫存區！`);
        }
        if (itemsToCache.length === 0) {
            console.log("請在上方選單選擇進度，或勾選重點單元。");
            return;
        }
    }

    let addedCount = 0;
    itemsToCache.forEach(item => {
        const isDuplicate = progressCache.some(p => p.path === item.path && p.topic === item.topic);
        if (!isDuplicate) {
            progressCache.push(item);
            addedCount++;
        }
    });

    if (addedCount > 0) {
        saveCache(); 
        if (checks.length === 0 && itemsToCache.length === 1) {
             console.log("進度已存入暫存區。");
        }
    } else if (checks.length > 0) {
         console.log("您勾選的重點已全部在暫存區中。");
    } else {
        console.log("您選擇的進度已在暫存區中。");
    }
}

function clearCache(showConfirm = false) {
    if (showConfirm) {
        if (!confirm("確定要清空所有暫存區的進度嗎？")) {
            return;
        }
    }
    progressCache = [];
    saveCache();
    console.log("暫存區已清空！");
}

function appendPages(text) {
  document.getElementById("pages").value = text.trim();
}

// ================ 級聯選單功能 ================
function loadBooks() {
    const subjectKey = document.getElementById('subject').value;
    const bookArea = document.getElementById('bookArea');
    if (!bookArea) return; // 安全檢查
    bookArea.innerHTML = '';

    if (typeof BOOKS === 'undefined' || !subjectKey || !BOOKS[subjectKey]) {
        if (subjectKey && typeof BOOKS === 'undefined') {
             bookArea.innerHTML = `<p style="color:red; font-size:0.9rem;"><b>嚴重錯誤：</b><br>1. 請確認 <code>data.js</code> 檔案在同一個資料夾。<br>2. 請確認 <code>data.js</code> 內部語法正確（例如大括號 <code>{}</code> 或逗號 <code>,</code> 是否有誤）。</p>`;
        } else if (subjectKey) {
             bookArea.innerHTML = `<p style="color:red; font-size:0.9rem;">錯誤：在 data.js 中找不到科目 "${subjectKey}" 的資料。</p>`;
        }
        return;
    }

    const books = Object.keys(BOOKS[subjectKey]);
    if (books.length === 0) return;

    let html = '<label>📖 冊別</label>';
    html += `<select id="bookSelect" onchange="loadChapters()">
                <option value="">--選冊別--</option>
                ${books.map(b => `<option value="${b}">${b}</option>`).join('')}
             </select>`;
    html += '<div id="chapterSelectArea" style="margin-top:10px;"></div>';
    html += '<div id="sectionSelectArea" style="margin-top:10px;"></div>';
    html += '<div id="topicArea" style="margin-top:10px;"></div>';
    bookArea.innerHTML = html;
}

function loadChapters() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const bookName = bookSelect ? bookSelect.value : '';

    const chapterArea = document.getElementById('chapterSelectArea');
    const sectionArea = document.getElementById('sectionSelectArea');
    const topicArea = document.getElementById('topicArea');

    if (chapterArea) chapterArea.innerHTML = '';
    if (sectionArea) sectionArea.innerHTML = '';
    if (topicArea) topicArea.innerHTML = '';
    if (!bookName) return;

    if (typeof BOOKS === 'undefined' || !BOOKS[subjectKey] || !BOOKS[subjectKey][bookName]) {
        console.error("loadChapters 錯誤：找不到資料", subjectKey, bookName);
        return;
    }

    const chapters = Object.keys(BOOKS[subjectKey][bookName]);
    let html = '<label>📑 章節</label>';
    html += `<select id="chapterSelect" onchange="loadSections()">
                <option value="">--選章節--</option>
                ${chapters.map(c => `<option value="${c}">${c}</option>`).join('')}
             </select>`;
    if (chapterArea) chapterArea.innerHTML = html;
}

function loadSections() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const bookName = bookSelect ? bookSelect.value : '';
    const chapterName = chapterSelect ? chapterSelect.value : '';

    const sectionArea = document.getElementById('sectionSelectArea');
    const topicArea = document.getElementById('topicArea');

    if (sectionArea) sectionArea.innerHTML = '';
    if (topicArea) topicArea.innerHTML = '';
    if (!chapterName) return;

    if (typeof BOOKS === 'undefined' || !BOOKS[subjectKey] || !BOOKS[subjectKey][bookName] || !BOOKS[subjectKey][bookName][chapterName]) {
        console.error("loadSections 錯誤：找不到資料", subjectKey, bookName, chapterName);
        return;
    }

    // [v13.1] 確保 Object.keys 是正確的
    const sections = Object.keys(BOOKS[subjectKey][bookName][chapterName]);

    let html = '<label>📝 小節</label>';
    html += `<select id="sectionSelect" onchange="loadTopics()">
                <option value="">--選小節--</option>
                ${sections.map(s => `<option value="${s}">${s}</option>`).join('')}
             </select>`;
    if (sectionArea) sectionArea.innerHTML = html;
}

function loadTopics() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const sectionSelect = document.getElementById('sectionSelect');

    const bookName = bookSelect ? bookSelect.value : '';
    const chapterName = chapterSelect ? chapterSelect.value : '';
    const sectionName = sectionSelect ? sectionSelect.value : '';
    
    const topicArea = document.getElementById('topicArea');
    if (!topicArea) return; // 安全檢查
    topicArea.innerHTML = '';
    if (!sectionName) return;

    if (typeof BOOKS === 'undefined' || !BOOKS[subjectKey] || !BOOKS[subjectKey][bookName] || !BOOKS[subjectKey][bookName][chapterName] || !BOOKS[subjectKey][bookName][chapterName][sectionName]) {
        console.error("loadTopics 錯誤：找不到資料", subjectKey, bookName, chapterName, sectionName);
        return;
    }

    const topics = BOOKS[subjectKey][bookName][chapterName][sectionName];

    if (!Array.isArray(topics)) {
        console.error("資料格式錯誤： 'topics' 應該是一個陣列，但卻是：", topics);
        topicArea.innerHTML = `<p style="color:red; font-size:0.9rem;">資料錯誤：此小節 (${sectionName}) 底下沒有「重點」列表。</p>`;
        return;
    }

    let html = '<label>✅ 今日進度 (可複選)</label>';
    html += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 8px; border-radius: 8px;">';
    topics.forEach((topic, index) => {
        const progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
        const uniqueId = `topic-${sectionName.replace(/\s/g, '_')}-${index}`;
        html += `<div class="unit-row">
                    <input type="checkbox" id="${uniqueId}" value="${progressPath}" data-topic-name="${topic}">
                    <label for="${uniqueId}" class="unit-label">${topic}</label>
                 </div>`;
    });
    html += '</div>';
    topicArea.innerHTML = html;
}

// ================ 日期功能 (v13.1 修正) ================
function formatDate(date) {
  const d = new Date(date);
  const year = d.getFullYear();
  // *** [v13.1 修正] 這裡就是修正點： '0' ( ... ) -> '0' + ( ... ) ***
  const month = ('0' + (d.getMonth() + 1)).slice(-2);
  const day = ('0' + d.getDate()).slice(-2);
  return `${year}-${month}-${day}`;
}
function setToday(){
  const dateInput = document.getElementById("dateInput");
  if (dateInput) {
    dateInput.value = formatDate(new Date());
  }
}
function setTomorrow(){
  const dateInput = document.getElementById("dateInput");
  if (dateInput) {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateInput.value = formatDate(tomorrow);
  }
}

// ================ 模板功能 ================
function saveTemplates() { localStorage.setItem('teachingLogTemplates', JSON.stringify(templates)); }
function renderTemplates() {
  const list = document.getElementById("templateList");
  if (list) {
      list.innerHTML = templates.map((t, i) =>
        `<span class="chip" onclick="applyTemplate('${t}')" oncontextmenu="deleteTemplate(${i}, true); return false;">${t}</span>`
      ).join('');
  }
}
function addTemplate() {
  const grade = document.getElementById("gradeSelect").value || "";
  const type = document.getElementById("classTypeSelect").value || "";
  const subj = document.getElementById("subjectSelect").value || "";
  const custom = document.getElementById("customClassName").value.trim() || "";
  const name = custom || `${grade}${subj}${type}`;
  if (name && !templates.includes(name)) {
    templates.push(name);
    saveTemplates();
    renderTemplates();
  }
}
function applyTemplate(name) {
  document.getElementById("customClassName").value = name;
}
function deleteTemplate(index, showConfirm = false) {
    if (showConfirm && !confirm(`確定刪除模板：${templates[index]} 嗎？`)) {
        return;
    }
    templates.splice(index, 1);
    saveTemplates();
    renderTemplates();
    console.log(`模板已刪除。`);
}
function fillTemplate() {
  const className = (() => {
    const grade = document.getElementById("gradeSelect").value || "";
    const type = document.getElementById("classTypeSelect").value || "";
    const subj = document.getElementById("subjectSelect").value || "";
    const custom = document.getElementById("customClassName").value.trim();
    if (custom) return custom;
    return (grade + subj + type);
  })();
  document.getElementById("customClassName").value = className;
}
function clearTemplates(showConfirm = false) {
    if (showConfirm && !confirm("確定清空所有班級模板嗎？")) {
        return;
    }
    templates = [];
    saveTemplates();
    renderTemplates();
    console.log("所有班級模板已清空。");
}

// ================ 作業句庫功能 ================
function saveSentences() { localStorage.setItem('homeworkSentences', JSON.stringify(sentences)); }
function renderSentences() {
  const list = document.getElementById("sentenceChips");
  if(list) {
      list.innerHTML = sentences.map((s, i) =>
        `<span class="chip" onclick="appendHomework('${s}')" oncontextmenu="deleteSentence(${i}, true); return false;">${s}</span>`
      ).join('');
  }
}
function addSentence() {
  const newS = document.getElementById("newSentence").value.trim();
  if (newS && !sentences.includes(newS)) {
    sentences.push(newS);
    saveSentences();
    renderSentences();
    document.getElementById("newSentence").value = '';
  }
}
function appendHomework(s) {
  const homework = document.getElementById("homework");
  if (homework.value.trim() === '') {
    homework.value = s;
  } else if (!homework.value.includes(s)) {
    homework.value += (homework.value.endsWith('。') || homework.value.endsWith('、') || homework.value.endsWith('！') || homework.value.endsWith('？') ? '' : '＋') + s;
  }
}
function deleteSentence(index, showConfirm = false) {
    if (showConfirm && !confirm(`確定刪除句庫：${sentences[index]} 嗎？`)) {
        return;
    }
    sentences.splice(index, 1);
    saveSentences();
    renderSentences();
    console.log("句庫項目已刪除。");
}

// ================ 產生日誌功能 ================
function generate() {
    const customClassName = document.getElementById("customClassName").value.trim();
    const date = document.getElementById("dateInput").value.trim();
    const pages = document.getElementById("pages").value.trim();
    const quiz = document.getElementById("quiz").value.trim();
    const homework = document.getElementById("homework").value.trim();

    const currentChecks = document.querySelectorAll("#topicArea input[type=checkbox]:checked");
    if (currentChecks.length > 0) {
        console.log(`偵測到 ${currentChecks.length} 個勾選重點，自動存入暫存區。`);
        currentChecks.forEach(cb => {
            const path = cb.value;
            const topic = cb.dataset.topicName;
            const newItem = { path: path, topic: topic };
            const isDuplicate = progressCache.some(item => item.path === path && item.topic === topic);
            if (!isDuplicate) {
                progressCache.push(newItem);
            }
            cb.checked = false;
        });
        saveCache();
    }

    const className = (() => {
        if (customClassName) return customClassName;
        const grade = document.getElementById("gradeSelect").value || "";
        const type = document.getElementById("classTypeSelect").value || "";
        const subj = document.getElementById("subjectSelect").value || "";
        return (grade + subj + type).trim();
    })();

    let progressToOutput = [];
    if (progressCache.length > 0) {
        progressToOutput = [...progressCache];
        console.log("進度來源：暫存區");
    } else {
        const subjectSelect = document.getElementById('subject');
        const subjectKey = subjectSelect ? subjectSelect.value : '';
        const subjectName = subjectSelect ? subjectSelect.options[subjectSelect.selectedIndex].text : '';
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const sectionSelect = document.getElementById('sectionSelect');
        const bookName = bookSelect ? bookSelect.value : '';
        const chapterName = chapterSelect ? chapterSelect.value : '';
        const sectionName = sectionSelect ? sectionSelect.value : '';
        let progressPath = '';
        let progressName = '';

        if (typeof BOOKS === 'undefined') {
             console.error("BOOKS 物件未定義。請確認 data.js 已正確載入。");
             return;
        }
        if (sectionName) {
            progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
            progressName = sectionName;
        } else if (chapterName) {
            progressPath = `${bookName} / ${chapterName}`;
            progressName = chapterName;
        } else if (bookName) {
            progressPath = `${bookName}`;
            progressName = bookName;
        } else if (subjectKey && BOOKS[subjectKey]) {
            Object.keys(BOOKS[subjectKey]).forEach(bName => {
                 progressToOutput.push({ path: bName, topic: subjectName });
            });
            console.log("進度來源：選單 (只選科目)");
        }
        if (progressPath && progressName) {
             progressToOutput.push({ path: progressPath, topic: progressName });
             console.log("進度來源：選單 (最高層級)");
        }
    }

    const groupedProgress = new Map();
    progressToOutput.forEach(item => {
      const path = item.path;
      const topic = item.topic || path.split(' / ').pop();
      if (groupedProgress.has(path)) {
        if (!groupedProgress.get(path).includes(topic)) {
             groupedProgress.get(path).push(topic);
        }
      } else {
        groupedProgress.set(path, [topic]);
      }
    });

    const progressLines = [];
    groupedProgress.forEach((topics, path) => {
      const combinedTopics = topics.join(' ＋ ');
      const parts = path.split(' / ');
      const lastPart = parts.slice(-1)[0];
      const subjectDropdown = document.getElementById('subject');
      const selectedSubjectText = subjectDropdown ? subjectDropdown.options[subjectDropdown.selectedIndex].text : '';
      const isSingleMatch = (topics.length === 1 && (topics[0] === lastPart || topics[0] === selectedSubjectText));

      if (isSingleMatch) {
         progressLines.push(`‧ ${path}`);
      } else {
         progressLines.push(`‧ ${path} (${combinedTopics})`);
      }
    });
    const progressOutput = progressLines.join('\n');

    let result = [];
    if (className) { result.push(`🏫 班級\n${className}`); }
    if (date) { result.push(`🗓️ 日期\n${date}`); }
    if (progressOutput) { result.push(`📘 今日進度\n${progressOutput}`); }
    if (pages) { result.push(`📄 頁數\n${pages}`); }
    if (quiz) { result.push(`🧾 小考\n${quiz}`); }
    if (homework) { result.push(`🏠 作業\n${homework}`); }
    
    const out = document.getElementById("output");
    out.style.display="block";
    out.textContent = result.join('\n').trim();
    out.scrollIntoView({behavior:"smooth"});

    if (progressCache.length > 0) {
        progressCache = [];
        saveCache();
    }
}

function copyOutput(){
    const text=document.getElementById("output").textContent;
    if(!text) {
        console.log("請先產生內容");
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        console.log("已複製到剪貼簿！");
    }).catch(err => {
        console.error('複製失敗:', err);
    });
}

function clearAll(showConfirm = false){
    if (showConfirm && !confirm("確定清空所有輸入框內容與暫存區嗎？")) {
        return;
    }
    document.getElementById("dateInput").value = "";
    document.getElementById("bookArea").innerHTML = "";
    document.getElementById("pages").value = "";
    document.getElementById("quiz").value = "";
    document.getElementById("homework").value = "";
    document.getElementById("customClassName").value = "";
    document.getElementById("output").textContent = "";
    document.getElementById("output").style.display="none";
    progressCache = [];
    saveCache();
    document.getElementById("importTextArea").value = "";
    document.getElementById("exportTextArea").value = "";
    document.getElementById("exportArea").style.display = "none";
    
    // 重設科目選單
    const subjectSelect = document.getElementById('subject');
    if (subjectSelect) subjectSelect.selectedIndex = 0;
    
    // 重新設定日期為今天
    setToday();
    
    console.log("所有內容已清空！");
}

// ================ 初始化 (v13.1 修正) ================
document.addEventListener('DOMContentLoaded', () => {
    try {
        // 檢查 "BOOKS" 是否已定義
        if (typeof BOOKS === 'undefined') {
            console.error("嚴重錯誤：data.js 未載入或 'BOOKS' 物件未定義。");
            const bookArea = document.getElementById('bookArea');
            if (bookArea) {
                 bookArea.innerHTML = `<p style="color:red; font-size:0.9rem;"><b>嚴重錯誤：</b><br>1. 請確認 <code>data.js</code> 檔案在同一個資料夾。<br>2. 請確認 <code>data.js</code> 內部語法正確（例如大括號 <code>{}</code> 或逗號 <code>,</code> 是否有誤）。<br>3. 修正 <code>data.js</code> 檔案後，請「<b>重新整理</b>」頁面。</p>`;
            }
        }

        if (!document.getElementById("dateInput").value) {
            setToday();
        }
        
        // 立即渲染暫存和模板
        renderCache();
        renderTemplates();
        renderSentences();
        
    } catch (e) {
        console.error("初始化時發生嚴重錯誤：", e);
        // 頁面發生嚴重錯誤，可能是 DOM 元素不存在
        document.body.innerHTML = `<div style="padding:20px; text-align:center; background:white; border:2px solid red;"><h1>網頁載入失敗</h1><p>HTML 結構可能已損毀，請檢查 <code>index.html</code> 檔案是否完整。</p><p>錯誤訊息： ${e.message}</p></div>`;
    }
});
</script>

</body>
</html>