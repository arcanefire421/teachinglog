<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“˜ æ•™å­¸æ—¥èªŒç”Ÿæˆå™¨ (v13.1 - ç©©å®šç‰ˆ)</title>
<style>
/* ç¢ºä¿æ‰‹æ©Ÿç›¸å®¹æ€§åŠç¾è§€ (CSS) */
body { font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:#f5f7fb;margin:0;padding:12px;color:#222;max-width:520px;margin-left:auto;margin-right:auto;}
h1{text-align:center;font-size:1.5rem;margin:12px 0 14px 0;}
.card{background:#fff;border-radius:12px;padding:12px 10px;margin-bottom:12px;
  box-shadow:0 2px 8px rgba(0,20,50,0.06);}
label{font-weight:600;display:block;margin-top:6px;margin-bottom:2px;}
input,select,textarea{width:100%;padding:8px;border-radius:8px;font-size:1rem;
  border:1px solid #ccc;box-sizing:border-box;margin-top:2px;}
textarea{resize:vertical;font-size:1rem;}
button{background:#2563eb;color:white;border:none;border-radius:8px;padding:9px 12px;
  margin-top:8px;cursor:pointer;font-weight:bold;font-size:1rem;margin-right:6px;}
button.danger{background:#ef4444;}button.green{background:#22c55e;}button.orange{background:#f59e0b;}
.section{border-top:1px solid #e5e7eb;margin-top:8px;padding-top:8px;}
.chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;
  margin:4px 3px 3px 0;background:#eef3fc;font-size:0.93rem;cursor:pointer;}
.chip:hover{background:#e2e8f0;}
.output{font-family:"Noto Sans Mono","Consolas",monospace;border-radius:8px;
  line-height:1.6;background:#fff;border:1px solid #e5e7eb;padding:14px 12px;margin-top:10px;
  font-size:1.05rem;white-space:pre-wrap;letter-spacing:0.012em;}
@media (max-width:520px){
  body{padding:4px;}
  .output{font-size:1.09rem;padding:8px 6px;}
  input,select,textarea{font-size:1.01rem;}
}
.select-group {
    display: flex;
    gap: 5px;
}
.select-group select {
    width: 33.33%;
    margin-top: 0;
}
.select-group + input {
    margin-top: 5px;
}
.button-row {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.button-row button {
    margin-top: 0;
    margin-right: 0;
    flex-grow: 1;
    width: auto;
}
.unit-row{
  display: flex;
  align-items: flex-start;
  margin-top: 5px;
  line-height: 1.2;
}
.unit-row input[type=checkbox]{
  width: auto;
  margin: 2px 5px 0 0;
  transform: scale(1.1);
  flex-shrink: 0;
}
.unit-label{
  flex: 1;
  display: inline;
  margin-top: 0;
}
#progressCache {
    margin-top: 10px;
    border: 1px dashed #2563eb;
    background: #f0f7ff;
    padding: 10px;
    border-radius: 8px;
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.95rem;
}
#progressCache .cache-item {
    margin-bottom: 5px;
    color: #1e40af;
    line-height: 1.3;
}
</style>
</head>
<body>
<h1>ğŸ“˜ æ•™å­¸æ—¥èªŒç”Ÿæˆå™¨ (v13.1 - ç©©å®šç‰ˆ)</h1>

<div class="card">
  <label>ğŸ« ç­ç´šæ¨¡æ¿</label>
  <div class="select-group">
    <select id="gradeSelect">
      <option>é«˜ä¸€</option>
      <option>é«˜äºŒ</option>
      <option>é«˜ä¸‰</option>
    </select>
    <select id="subjectSelect">
      <option>ç‰©ç†</option>
      <option>åŒ–å­¸</option>
      <option>ç”Ÿç‰©</option>
      <option>åœ°ç§‘</option>
    </select>
    <select id="classTypeSelect">
      <option>é€²åº¦</option>
      <option>ç¸½è¤‡ç¿’</option>
    </select>
  </div>
  <input id="customClassName" placeholder="æˆ–è‡ªè¨‚ç­ç´šåç¨±ï¼ˆå¯ç©ºç™½ï¼‰">
  <button class="green" onclick="addTemplate()">ï¼‹æ–°å¢æ¨¡æ¿</button>
  <button onclick="fillTemplate()">å¡«å…¥ç­å</button>
  <button class="danger" onclick="clearTemplates(true)">å…¨æ¸…æ¨¡æ¿</button>
  <div id="templateList" style="margin-top:5px;"></div>
</div>

<div class="card">
  <label>ğŸ—“ï¸ æ—¥æœŸ</label>
  <div style="display:flex;gap:7px;flex-wrap:wrap;">
    <input id="dateInput" placeholder="è‡ªå‹•ä»Šæ—¥">
    <button onclick="setToday()">ä»Šå¤©</button>
    <button onclick="setTomorrow()">æ˜å¤©</button>
  </div>
</div>

<div class="card">
  <label>ğŸ“š ç§‘ç›® / é€²åº¦é¸å–®</label>
  <select id="subject" onchange="loadBooks()">
    <option value="">--é¸ç§‘ç›®--</option>
    <option value="physics">ç‰©ç†</option>
    <option value="chemistry">åŒ–å­¸</option>
    <option value="biology">ç”Ÿç‰©</option>
    <option value="earth">åœ°ç§‘</option>
  </select>

  <div id="bookArea" class="section">
  </div>

  <div id="cacheArea" class="section" style="text-align: center;">
      <button class="orange" onclick="addToCache()">â¡ï¸ å­˜å…¥æš«å­˜å€</button>
      <button class="danger" onclick="clearCache(true)">ğŸ—‘ï¸ æ¸…ç©ºæš«å­˜</button>
  </div>

  <label style="margin-top: 10px;">ğŸ’¾ å·²é¸é€²åº¦æš«å­˜å€</label>
  <div id="progressCache">ç›®å‰ç„¡æš«å­˜é€²åº¦ã€‚</div>
</div>

<div class="card">
  <label>ğŸ“š èª²ç¨‹è³‡æ–™ç”¢ç”Ÿå™¨</label>
  <p style="font-size:0.9rem; margin-top:0; color:#555;">
    è«‹è²¼ä¸Šç”¨ <b>Tabéµ</b> ç¸®æ’çš„èª²ç¨‹æ–‡å­—ã€‚<b>æœ€ä¸Šå±¤å¿…é ˆæ˜¯ã€Œå†Šåˆ¥ã€åç¨±ã€‚</b><br>
    ç”¢ç”Ÿå¾Œï¼Œè«‹æ‰‹å‹•è¤‡è£½å…§å®¹ä¸¦è²¼åˆ° <code>data.js</code> æª”æ¡ˆä¸­ã€‚
  </p>
  <textarea id="importTextArea" rows="8" placeholder="é¸ä¿®ç‰©ç† ( I )
	ç¬¬1ç«  æ¸¬é‡èˆ‡ä¸ç¢ºå®šåº¦
		1-1 ä¸ç¢ºå®šåº¦èˆ‡æœ‰æ•ˆæ•¸å­—
			çœŸå€¼èˆ‡ä¸ç¢ºå®šåº¦(é¸ä¿®)
	ç¬¬2ç«  é‹å‹•å­¸ï¼ç›´ç·šé‹å‹•
		2-1 ä½ç½®ã€è·¯å¾‘é•·èˆ‡ä½ç§»
			ä½ç½®èˆ‡åæ¨™è»¸(é¸ä¿®)" style="font-family:monospace;"></textarea>
  <button class="green" onclick="parseTextToJSON()">ç”¢ç”Ÿ data.js å…§å®¹</button>

  <div id="exportArea" class="section" style="display:none;">
    <label>âœ… ç”¢ç”Ÿçš„ JavaScript å…§å®¹</label>
    <textarea id="exportTextArea" rows="10" readonly style="background:#f9f9f9; color:#333; font-family:monospace;"></textarea>
  </div>
</div>

<div class="card">
  <div class="section">
    <label>ğŸ“„ é æ•¸</label>
    <input id="pages" placeholder="ä¾‹ï¼šp.45~52">
    <div style="display:flex;gap:5px;flex-wrap:wrap;">
      <span class="chip" onclick="appendPages('p. ')">p. </span>
      <span class="chip" onclick="appendPages('p. 5~8')">p. 5~8</span>
      <span class="chip" onclick="appendPages('p. 10~15')">p. 10~15</span>
      <span class="chip" onclick="appendPages('p. 25~30')">p. 25~30</span>
      <span class="chip" onclick="appendPages('p. 50~55')">p. 50~55</span>
    </div>
  </div>
  <div class="section">
    <label>ğŸ§¾ å°è€ƒ</label>
    <input id="quiz" placeholder="ä¾‹ï¼šç¬¬2ç« å°è€ƒ">
  </div>
  <div class="section">
    <label>ğŸ  å›å®¶ä½œæ¥­</label>
    <textarea id="homework" rows="2" placeholder="ä¾‹ï¼šè¬›ç¾© p.53~55ï¼‹ç¿’é¡Œ"></textarea>
    <div id="sentenceChips"></div>
    <input id="newSentence" placeholder="åŠ åˆ°å¸¸ç”¨ä½œæ¥­å¥åº«ï¼ˆå³éµåˆªï¼‰">
    <button class="green" onclick="addSentence()">ï¼‹å¥åº«</button>
  </div>
</div>

<div class="card">
  <div class="button-row">
    <button class="orange" onclick="generate()">ğŸš€ ç”¢ç”Ÿ</button>
    <button onclick="copyOutput()">ğŸ“‹ è¤‡è£½</button>
    <button class="danger" onclick="clearAll(true)">ğŸ§¹ æ¸…ç©º</button>
  </div>
  <div id="output" class="output" style="display:none"></div>
</div>

<script src="data.js"></script>

<script>
// ================ JS è®Šæ•¸èˆ‡è¼”åŠ©å‡½æ•¸ (v13.1 ä¿®æ­£) ================

/**
 * [v13 ä¿®æ­£] æ–°å¢ï¼šå®‰å…¨åœ°å¾ localStorage è®€å– JSON è³‡æ–™
 * @param {string} key - localStorage çš„ key
 * @param {any} defaultValue - å¦‚æœè§£æå¤±æ•—æ™‚çš„é è¨­å€¼
 * @returns {any} è§£æå¾Œçš„ç‰©ä»¶æˆ–é è¨­å€¼
 */
function safeJSONParse(key, defaultValue) {
    try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
    } catch (e) {
        console.warn(`localStorage è³‡æ–™ '${key}' ææ¯€ï¼Œå·²é‡è¨­ã€‚`, e);
        localStorage.removeItem(key); // æ¸…é™¤ææ¯€çš„è³‡æ–™
        return defaultValue;
    }
}

// [v13 ä¿®æ­£] ä½¿ç”¨ safeJSONParse ä¾†åˆå§‹åŒ–ï¼Œé¿å…ç¶²é å› 
let progressCache = safeJSONParse('teachingLogCache', []);
let templates = safeJSONParse('teachingLogTemplates', []);
let sentences = safeJSONParse('homeworkSentences', ["è¬›ç¾© p.X~Y", "ç¿’é¡Œå·", "è€ƒå·è¨‚æ­£", "è¤‡ç¿’æŒ‡å®šç¯„åœ"]);


function saveCache() {
    localStorage.setItem('teachingLogCache', JSON.stringify(progressCache));
    renderCache();
}

function renderCache() {
    const cacheDiv = document.getElementById('progressCache');
    if (!cacheDiv) return; // å®‰å…¨æª¢æŸ¥
    if (progressCache.length === 0) {
        cacheDiv.innerHTML = 'ç›®å‰ç„¡æš«å­˜é€²åº¦ã€‚';
        return;
    }
    const groupedCache = new Map();
    progressCache.forEach(item => {
        const path = item.path;
        if (groupedCache.has(path)) {
            if (!groupedCache.get(path).includes(item.topic)) {
                 groupedCache.get(path).push(item.topic);
            }
        } else {
            groupedCache.set(path, [item.topic]);
        }
    });

    let html = '';
    groupedCache.forEach((topics, path) => {
        const combinedTopics = topics.join(' ï¼‹ ');
        const pathParts = path.split(' / ');
        const lastPart = pathParts.slice(-1)[0];
        const isPathOnly = topics.length === 1 && topics[0] === lastPart;
        
        if (isPathOnly) {
             html += `<div class="cache-item">â€§ ${path}</div>`;
        } else {
             html += `<div class="cache-item">â€§ ${path} <br> (${combinedTopics})</div>`;
        }
    });
    cacheDiv.innerHTML = html;
}

// ================ èª²ç¨‹è³‡æ–™ç”¢ç”Ÿå™¨ (Parser) å‡½æ•¸ ================
function parseTextToJSON() {
    const text = document.getElementById('importTextArea').value;
    const lines = text.split('\n');
    let bookData = {};
    let currentBook = null;
    let currentChapter = null;
    let currentSection = null;

    const exportAreaDiv = document.getElementById('exportArea');
    const exportTextArea = document.getElementById('exportTextArea');

    try {
        if (text.trim() === "") {
            throw new Error("è¼¸å…¥æ¡†æ˜¯ç©ºçš„ã€‚");
        }
        for (const rawLine of lines) {
            let line = rawLine;
            if (line.trim() === "") continue; 
            let indentLevel = 0;
            while (line.startsWith('\t')) {
                line = line.substring(1);
                indentLevel++;
            }
            line = line.trim();
            if (line === "") continue;

            switch (indentLevel) {
                case 0: // Level 1 - å†Šåˆ¥
                    currentBook = line;
                    bookData[currentBook] = {};
                    currentChapter = null;
                    currentSection = null;
                    break;
                case 1: // Level 2 - ç« ç¯€
                    if (!currentBook) throw new Error(`[æ ¼å¼éŒ¯èª¤] ç™¼ç¾ã€Œç« ç¯€ã€ä½†å°šæœªå®šç¾©ã€Œå†Šåˆ¥ã€ï¼š${line}`);
                    currentChapter = line;
                    bookData[currentBook][currentChapter] = {};
                    currentSection = null;
                    break;
                case 2: // Level 3 - å°ç¯€
                    if (!currentChapter) throw new Error(`[æ ¼å¼éŒ¯èª¤] ç™¼ç¾ã€Œå°ç¯€ã€ä½†å°šæœªå®šç¾©ã€Œç« ç¯€ã€ï¼š${line}`);
                    currentSection = line;
                    bookData[currentBook][currentChapter][currentSection] = [];
                    break;
                case 3: // Level 4 - é‡é»
                    if (!currentSection) throw new Error(`[æ ¼å¼éŒ¯èª¤] ç™¼ç¾ã€Œé‡é»ã€ä½†å°šæœªå®šç¾©ã€Œå°ç¯€ã€ï¼š${line}`);
                    bookData[currentBook][currentChapter][currentSection].push(line);
                    break;
                default:
                    if (currentSection) {
                        bookData[currentBook][currentChapter][currentSection].push(line);
                    } else {
                        console.warn("å¿½ç•¥ç¸®æ’æ ¼å¼éŒ¯èª¤çš„è¡Œï¼š", line);
                    }
                    break;
            }
        }
        if (Object.keys(bookData).length === 0) {
             throw new Error("æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•æœ‰æ•ˆçš„ã€Œå†Šåˆ¥ã€è³‡æ–™ã€‚è«‹ç¢ºèªæœ€ä¸Šå±¤ï¼ˆç„¡ç¸®æ’ï¼‰ç‚ºå†Šåˆ¥åç¨±ã€‚");
        }

        // å°‡JSç‰©ä»¶è½‰æ›ç‚ºæ ¼å¼åŒ–çš„ JSON å­—ä¸²
        let outputJson = JSON.stringify(bookData, null, 2);
        
        // ç§»é™¤æœ€å¤–å±¤çš„ {} ä¸¦å»é™¤ç©ºç™½
        outputJson = outputJson.slice(1, -1).trim();

        const instructions = `/* 1. è¤‡è£½ä¸‹æ–¹ã€Œæ‰€æœ‰ã€æ–‡å­—å…§å®¹ã€‚
 2. æ‰“é–‹æ‚¨çš„ data.js æª”æ¡ˆã€‚
 3. æ‰¾åˆ°æ‚¨è¦æ·»åŠ /è¦†è“‹çš„ã€Œç§‘ç›®ã€ï¼Œä¾‹å¦‚ "physics": { ... }
 4. å°‡è¤‡è£½çš„å…§å®¹è²¼åˆ°è©²ç§‘ç›®çš„ { } å¤§æ‹¬è™Ÿ *å…§éƒ¨*ã€‚

   ä¾‹å¦‚ï¼Œ"physics": {
     "åŸºç¤ç‰©ç†(å…¨)": { ... },  <-- (é€™æ˜¯èˆŠè³‡æ–™)
     
     (è²¼åœ¨é€™è£¡)
     "é¸ä¿®ç‰©ç†(I)": { ... }   <-- (é€™æ˜¯æ–°è²¼ä¸Šçš„)

   }
 5. æ³¨æ„ï¼šè«‹ç¢ºä¿ã€Œå†Šåˆ¥ã€ä¹‹é–“æœ‰é€—è™Ÿ ,
*/

`;
        exportTextArea.value = instructions + outputJson;
        exportAreaDiv.style.display = 'block';

    } catch (e) {
        exportTextArea.value = "è½‰æ›å¤±æ•—ï¼š\n" + e.message + "\n\nè«‹æª¢æŸ¥æ‚¨çš„ç¸®æ’æ ¼å¼æ˜¯å¦æ­£ç¢ºï¼ˆå¿…é ˆä½¿ç”¨ Tab éµï¼Œè€Œéç©ºç™½éµï¼‰ã€‚";
        exportAreaDiv.style.display = 'block';
    }
}

// ================ æ ¸å¿ƒé€²åº¦åŠŸèƒ½ ================
function addToCache() {
    let itemsToCache = [];
    const checks = document.querySelectorAll("#topicArea input[type=checkbox]:checked");

    if (checks.length > 0) {
        checks.forEach(cb => {
            const path = cb.value;
            const topic = cb.dataset.topicName;
            itemsToCache.push({ path: path, topic: topic });
            cb.checked = false; 
        });
        console.log(`å·²å°‡ ${checks.length} å€‹å‹¾é¸é‡é»å­˜å…¥æš«å­˜å€ï¼`);
    } else {
        const subjectSelect = document.getElementById('subject');
        const subjectKey = subjectSelect ? subjectSelect.value : '';
        const subjectName = subjectSelect ? subjectSelect.options[subjectSelect.selectedIndex].text : '';
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const sectionSelect = document.getElementById('sectionSelect');

        const bookName = bookSelect ? bookSelect.value : '';
        const chapterName = chapterSelect ? chapterSelect.value : '';
        const sectionName = sectionSelect ? sectionSelect.value : '';

        let progressPath = '';
        let progressName = '';

        if (subjectKey) {
            if (sectionName) {
                progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
                progressName = sectionName;
            } else if (chapterName) {
                progressPath = `${bookName} / ${chapterName}`;
                progressName = chapterName;
            } else if (bookName) {
                progressPath = `${bookName}`;
                progressName = bookName;
            } else {
                if (typeof BOOKS !== 'undefined' && BOOKS[subjectKey]) {
                    Object.keys(BOOKS[subjectKey]).forEach(bName => {
                        itemsToCache.push({ path: bName, topic: subjectName });
                    });
                     if (itemsToCache.length > 0) {
                         console.log(`åµæ¸¬åˆ°åªé¸ç§‘ç›®ï¼Œå·²å°‡ ${subjectName} æ¶‰åŠçš„ ${itemsToCache.length} å€‹å†Šåˆ¥ä½œç‚ºé€²åº¦å­˜å…¥æš«å­˜å€ï¼`);
                     }
                    itemsToCache.forEach(item => {
                        const isDuplicate = progressCache.some(p => p.path === item.path && p.topic === item.topic);
                        if (!isDuplicate) progressCache.push(item);
                    });
                    saveCache();
                    return;
                }
            }
        }
        if (progressPath && progressName) {
            itemsToCache.push({ path: progressPath, topic: progressName });
            console.log(`å·²å°‡é¸å–®æœ€é«˜å±¤ç´šï¼š${progressPath} å­˜å…¥æš«å­˜å€ï¼`);
        }
        if (itemsToCache.length === 0) {
            console.log("è«‹åœ¨ä¸Šæ–¹é¸å–®é¸æ“‡é€²åº¦ï¼Œæˆ–å‹¾é¸é‡é»å–®å…ƒã€‚");
            return;
        }
    }

    let addedCount = 0;
    itemsToCache.forEach(item => {
        const isDuplicate = progressCache.some(p => p.path === item.path && p.topic === item.topic);
        if (!isDuplicate) {
            progressCache.push(item);
            addedCount++;
        }
    });

    if (addedCount > 0) {
        saveCache(); 
        if (checks.length === 0 && itemsToCache.length === 1) {
             console.log("é€²åº¦å·²å­˜å…¥æš«å­˜å€ã€‚");
        }
    } else if (checks.length > 0) {
         console.log("æ‚¨å‹¾é¸çš„é‡é»å·²å…¨éƒ¨åœ¨æš«å­˜å€ä¸­ã€‚");
    } else {
        console.log("æ‚¨é¸æ“‡çš„é€²åº¦å·²åœ¨æš«å­˜å€ä¸­ã€‚");
    }
}

function clearCache(showConfirm = false) {
    if (showConfirm) {
        if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æš«å­˜å€çš„é€²åº¦å—ï¼Ÿ")) {
            return;
        }
    }
    progressCache = [];
    saveCache();
    console.log("æš«å­˜å€å·²æ¸…ç©ºï¼");
}

function appendPages(text) {
  document.getElementById("pages").value = text.trim();
}

// ================ ç´šè¯é¸å–®åŠŸèƒ½ ================
function loadBooks() {
    const subjectKey = document.getElementById('subject').value;
    const bookArea = document.getElementById('bookArea');
    if (!bookArea) return; // å®‰å…¨æª¢æŸ¥
    bookArea.innerHTML = '';

    if (typeof BOOKS === 'undefined' || !subjectKey || !BOOKS[subjectKey]) {
        if (subjectKey && typeof BOOKS === 'undefined') {
             bookArea.innerHTML = `<p style="color:red; font-size:0.9rem;"><b>åš´é‡éŒ¯èª¤ï¼š</b><br>1. è«‹ç¢ºèª <code>data.js</code> æª”æ¡ˆåœ¨åŒä¸€å€‹è³‡æ–™å¤¾ã€‚<br>2. è«‹ç¢ºèª <code>data.js</code> å…§éƒ¨èªæ³•æ­£ç¢ºï¼ˆä¾‹å¦‚å¤§æ‹¬è™Ÿ <code>{}</code> æˆ–é€—è™Ÿ <code>,</code> æ˜¯å¦æœ‰èª¤ï¼‰ã€‚</p>`;
        } else if (subjectKey) {
             bookArea.innerHTML = `<p style="color:red; font-size:0.9rem;">éŒ¯èª¤ï¼šåœ¨ data.js ä¸­æ‰¾ä¸åˆ°ç§‘ç›® "${subjectKey}" çš„è³‡æ–™ã€‚</p>`;
        }
        return;
    }

    const books = Object.keys(BOOKS[subjectKey]);
    if (books.length === 0) return;

    let html = '<label>ğŸ“– å†Šåˆ¥</label>';
    html += `<select id="bookSelect" onchange="loadChapters()">
                <option value="">--é¸å†Šåˆ¥--</option>
                ${books.map(b => `<option value="${b}">${b}</option>`).join('')}
             </select>`;
    html += '<div id="chapterSelectArea" style="margin-top:10px;"></div>';
    html += '<div id="sectionSelectArea" style="margin-top:10px;"></div>';
    html += '<div id="topicArea" style="margin-top:10px;"></div>';
    bookArea.innerHTML = html;
}

function loadChapters() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const bookName = bookSelect ? bookSelect.value : '';

    const chapterArea = document.getElementById('chapterSelectArea');
    const sectionArea = document.getElementById('sectionSelectArea');
    const topicArea = document.getElementById('topicArea');

    if (chapterArea) chapterArea.innerHTML = '';
    if (sectionArea) sectionArea.innerHTML = '';
    if (topicArea) topicArea.innerHTML = '';
    if (!bookName) return;

    if (typeof BOOKS === 'undefined' || !BOOKS[subjectKey] || !BOOKS[subjectKey][bookName]) {
        console.error("loadChapters éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™", subjectKey, bookName);
        return;
    }

    const chapters = Object.keys(BOOKS[subjectKey][bookName]);
    let html = '<label>ğŸ“‘ ç« ç¯€</label>';
    html += `<select id="chapterSelect" onchange="loadSections()">
                <option value="">--é¸ç« ç¯€--</option>
                ${chapters.map(c => `<option value="${c}">${c}</option>`).join('')}
             </select>`;
    if (chapterArea) chapterArea.innerHTML = html;
}

function loadSections() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const bookName = bookSelect ? bookSelect.value : '';
    const chapterName = chapterSelect ? chapterSelect.value : '';

    const sectionArea = document.getElementById('sectionSelectArea');
    const topicArea = document.getElementById('topicArea');

    if (sectionArea) sectionArea.innerHTML = '';
    if (topicArea) topicArea.innerHTML = '';
    if (!chapterName) return;

    if (typeof BOOKS === 'undefined' || !BOOKS[subjectKey] || !BOOKS[subjectKey][bookName] || !BOOKS[subjectKey][bookName][chapterName]) {
        console.error("loadSections éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™", subjectKey, bookName, chapterName);
        return;
    }

    // [v13.1] ç¢ºä¿ Object.keys æ˜¯æ­£ç¢ºçš„
    const sections = Object.keys(BOOKS[subjectKey][bookName][chapterName]);

    let html = '<label>ğŸ“ å°ç¯€</label>';
    html += `<select id="sectionSelect" onchange="loadTopics()">
                <option value="">--é¸å°ç¯€--</option>
                ${sections.map(s => `<option value="${s}">${s}</option>`).join('')}
             </select>`;
    if (sectionArea) sectionArea.innerHTML = html;
}

function loadTopics() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const sectionSelect = document.getElementById('sectionSelect');

    const bookName = bookSelect ? bookSelect.value : '';
    const chapterName = chapterSelect ? chapterSelect.value : '';
    const sectionName = sectionSelect ? sectionSelect.value : '';
    
    const topicArea = document.getElementById('topicArea');
    if (!topicArea) return; // å®‰å…¨æª¢æŸ¥
    topicArea.innerHTML = '';
    if (!sectionName) return;

    if (typeof BOOKS === 'undefined' || !BOOKS[subjectKey] || !BOOKS[subjectKey][bookName] || !BOOKS[subjectKey][bookName][chapterName] || !BOOKS[subjectKey][bookName][chapterName][sectionName]) {
        console.error("loadTopics éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™", subjectKey, bookName, chapterName, sectionName);
        return;
    }

    const topics = BOOKS[subjectKey][bookName][chapterName][sectionName];

    if (!Array.isArray(topics)) {
        console.error("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼š 'topics' æ‡‰è©²æ˜¯ä¸€å€‹é™£åˆ—ï¼Œä½†å»æ˜¯ï¼š", topics);
        topicArea.innerHTML = `<p style="color:red; font-size:0.9rem;">è³‡æ–™éŒ¯èª¤ï¼šæ­¤å°ç¯€ (${sectionName}) åº•ä¸‹æ²’æœ‰ã€Œé‡é»ã€åˆ—è¡¨ã€‚</p>`;
        return;
    }

    let html = '<label>âœ… ä»Šæ—¥é€²åº¦ (å¯è¤‡é¸)</label>';
    html += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 8px; border-radius: 8px;">';
    topics.forEach((topic, index) => {
        const progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
        const uniqueId = `topic-${sectionName.replace(/\s/g, '_')}-${index}`;
        html += `<div class="unit-row">
                    <input type="checkbox" id="${uniqueId}" value="${progressPath}" data-topic-name="${topic}">
                    <label for="${uniqueId}" class="unit-label">${topic}</label>
                 </div>`;
    });
    html += '</div>';
    topicArea.innerHTML = html;
}

// ================ æ—¥æœŸåŠŸèƒ½ (v13.1 ä¿®æ­£) ================
function formatDate(date) {
  const d = new Date(date);
  const year = d.getFullYear();
  // *** [v13.1 ä¿®æ­£] é€™è£¡å°±æ˜¯ä¿®æ­£é»ï¼š '0' ( ... ) -> '0' + ( ... ) ***
  const month = ('0' + (d.getMonth() + 1)).slice(-2);
  const day = ('0' + d.getDate()).slice(-2);
  return `${year}-${month}-${day}`;
}
function setToday(){
  const dateInput = document.getElementById("dateInput");
  if (dateInput) {
    dateInput.value = formatDate(new Date());
  }
}
function setTomorrow(){
  const dateInput = document.getElementById("dateInput");
  if (dateInput) {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateInput.value = formatDate(tomorrow);
  }
}

// ================ æ¨¡æ¿åŠŸèƒ½ ================
function saveTemplates() { localStorage.setItem('teachingLogTemplates', JSON.stringify(templates)); }
function renderTemplates() {
  const list = document.getElementById("templateList");
  if (list) {
      list.innerHTML = templates.map((t, i) =>
        `<span class="chip" onclick="applyTemplate('${t}')" oncontextmenu="deleteTemplate(${i}, true); return false;">${t}</span>`
      ).join('');
  }
}
function addTemplate() {
  const grade = document.getElementById("gradeSelect").value || "";
  const type = document.getElementById("classTypeSelect").value || "";
  const subj = document.getElementById("subjectSelect").value || "";
  const custom = document.getElementById("customClassName").value.trim() || "";
  const name = custom || `${grade}${subj}${type}`;
  if (name && !templates.includes(name)) {
    templates.push(name);
    saveTemplates();
    renderTemplates();
  }
}
function applyTemplate(name) {
  document.getElementById("customClassName").value = name;
}
function deleteTemplate(index, showConfirm = false) {
    if (showConfirm && !confirm(`ç¢ºå®šåˆªé™¤æ¨¡æ¿ï¼š${templates[index]} å—ï¼Ÿ`)) {
        return;
    }
    templates.splice(index, 1);
    saveTemplates();
    renderTemplates();
    console.log(`æ¨¡æ¿å·²åˆªé™¤ã€‚`);
}
function fillTemplate() {
  const className = (() => {
    const grade = document.getElementById("gradeSelect").value || "";
    const type = document.getElementById("classTypeSelect").value || "";
    const subj = document.getElementById("subjectSelect").value || "";
    const custom = document.getElementById("customClassName").value.trim();
    if (custom) return custom;
    return (grade + subj + type);
  })();
  document.getElementById("customClassName").value = className;
}
function clearTemplates(showConfirm = false) {
    if (showConfirm && !confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç­ç´šæ¨¡æ¿å—ï¼Ÿ")) {
        return;
    }
    templates = [];
    saveTemplates();
    renderTemplates();
    console.log("æ‰€æœ‰ç­ç´šæ¨¡æ¿å·²æ¸…ç©ºã€‚");
}

// ================ ä½œæ¥­å¥åº«åŠŸèƒ½ ================
function saveSentences() { localStorage.setItem('homeworkSentences', JSON.stringify(sentences)); }
function renderSentences() {
  const list = document.getElementById("sentenceChips");
  if(list) {
      list.innerHTML = sentences.map((s, i) =>
        `<span class="chip" onclick="appendHomework('${s}')" oncontextmenu="deleteSentence(${i}, true); return false;">${s}</span>`
      ).join('');
  }
}
function addSentence() {
  const newS = document.getElementById("newSentence").value.trim();
  if (newS && !sentences.includes(newS)) {
    sentences.push(newS);
    saveSentences();
    renderSentences();
    document.getElementById("newSentence").value = '';
  }
}
function appendHomework(s) {
  const homework = document.getElementById("homework");
  if (homework.value.trim() === '') {
    homework.value = s;
  } else if (!homework.value.includes(s)) {
    homework.value += (homework.value.endsWith('ã€‚') || homework.value.endsWith('ã€') || homework.value.endsWith('ï¼') || homework.value.endsWith('ï¼Ÿ') ? '' : 'ï¼‹') + s;
  }
}
function deleteSentence(index, showConfirm = false) {
    if (showConfirm && !confirm(`ç¢ºå®šåˆªé™¤å¥åº«ï¼š${sentences[index]} å—ï¼Ÿ`)) {
        return;
    }
    sentences.splice(index, 1);
    saveSentences();
    renderSentences();
    console.log("å¥åº«é …ç›®å·²åˆªé™¤ã€‚");
}

// ================ ç”¢ç”Ÿæ—¥èªŒåŠŸèƒ½ ================
function generate() {
    const customClassName = document.getElementById("customClassName").value.trim();
    const date = document.getElementById("dateInput").value.trim();
    const pages = document.getElementById("pages").value.trim();
    const quiz = document.getElementById("quiz").value.trim();
    const homework = document.getElementById("homework").value.trim();

    const currentChecks = document.querySelectorAll("#topicArea input[type=checkbox]:checked");
    if (currentChecks.length > 0) {
        console.log(`åµæ¸¬åˆ° ${currentChecks.length} å€‹å‹¾é¸é‡é»ï¼Œè‡ªå‹•å­˜å…¥æš«å­˜å€ã€‚`);
        currentChecks.forEach(cb => {
            const path = cb.value;
            const topic = cb.dataset.topicName;
            const newItem = { path: path, topic: topic };
            const isDuplicate = progressCache.some(item => item.path === path && item.topic === topic);
            if (!isDuplicate) {
                progressCache.push(newItem);
            }
            cb.checked = false;
        });
        saveCache();
    }

    const className = (() => {
        if (customClassName) return customClassName;
        const grade = document.getElementById("gradeSelect").value || "";
        const type = document.getElementById("classTypeSelect").value || "";
        const subj = document.getElementById("subjectSelect").value || "";
        return (grade + subj + type).trim();
    })();

    let progressToOutput = [];
    if (progressCache.length > 0) {
        progressToOutput = [...progressCache];
        console.log("é€²åº¦ä¾†æºï¼šæš«å­˜å€");
    } else {
        const subjectSelect = document.getElementById('subject');
        const subjectKey = subjectSelect ? subjectSelect.value : '';
        const subjectName = subjectSelect ? subjectSelect.options[subjectSelect.selectedIndex].text : '';
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const sectionSelect = document.getElementById('sectionSelect');
        const bookName = bookSelect ? bookSelect.value : '';
        const chapterName = chapterSelect ? chapterSelect.value : '';
        const sectionName = sectionSelect ? sectionSelect.value : '';
        let progressPath = '';
        let progressName = '';

        if (typeof BOOKS === 'undefined') {
             console.error("BOOKS ç‰©ä»¶æœªå®šç¾©ã€‚è«‹ç¢ºèª data.js å·²æ­£ç¢ºè¼‰å…¥ã€‚");
             return;
        }
        if (sectionName) {
            progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
            progressName = sectionName;
        } else if (chapterName) {
            progressPath = `${bookName} / ${chapterName}`;
            progressName = chapterName;
        } else if (bookName) {
            progressPath = `${bookName}`;
            progressName = bookName;
        } else if (subjectKey && BOOKS[subjectKey]) {
            Object.keys(BOOKS[subjectKey]).forEach(bName => {
                 progressToOutput.push({ path: bName, topic: subjectName });
            });
            console.log("é€²åº¦ä¾†æºï¼šé¸å–® (åªé¸ç§‘ç›®)");
        }
        if (progressPath && progressName) {
             progressToOutput.push({ path: progressPath, topic: progressName });
             console.log("é€²åº¦ä¾†æºï¼šé¸å–® (æœ€é«˜å±¤ç´š)");
        }
    }

    const groupedProgress = new Map();
    progressToOutput.forEach(item => {
      const path = item.path;
      const topic = item.topic || path.split(' / ').pop();
      if (groupedProgress.has(path)) {
        if (!groupedProgress.get(path).includes(topic)) {
             groupedProgress.get(path).push(topic);
        }
      } else {
        groupedProgress.set(path, [topic]);
      }
    });

    const progressLines = [];
    groupedProgress.forEach((topics, path) => {
      const combinedTopics = topics.join(' ï¼‹ ');
      const parts = path.split(' / ');
      const lastPart = parts.slice(-1)[0];
      const subjectDropdown = document.getElementById('subject');
      const selectedSubjectText = subjectDropdown ? subjectDropdown.options[subjectDropdown.selectedIndex].text : '';
      const isSingleMatch = (topics.length === 1 && (topics[0] === lastPart || topics[0] === selectedSubjectText));

      if (isSingleMatch) {
         progressLines.push(`â€§ ${path}`);
      } else {
         progressLines.push(`â€§ ${path} (${combinedTopics})`);
      }
    });
    const progressOutput = progressLines.join('\n');

    let result = [];
    if (className) { result.push(`ğŸ« ç­ç´š\n${className}`); }
    if (date) { result.push(`ğŸ—“ï¸ æ—¥æœŸ\n${date}`); }
    if (progressOutput) { result.push(`ğŸ“˜ ä»Šæ—¥é€²åº¦\n${progressOutput}`); }
    if (pages) { result.push(`ğŸ“„ é æ•¸\n${pages}`); }
    if (quiz) { result.push(`ğŸ§¾ å°è€ƒ\n${quiz}`); }
    if (homework) { result.push(`ğŸ  ä½œæ¥­\n${homework}`); }
    
    const out = document.getElementById("output");
    out.style.display="block";
    out.textContent = result.join('\n').trim();
    out.scrollIntoView({behavior:"smooth"});

    if (progressCache.length > 0) {
        progressCache = [];
        saveCache();
    }
}

function copyOutput(){
    const text=document.getElementById("output").textContent;
    if(!text) {
        console.log("è«‹å…ˆç”¢ç”Ÿå…§å®¹");
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        console.log("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
    });
}

function clearAll(showConfirm = false){
    if (showConfirm && !confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¡†å…§å®¹èˆ‡æš«å­˜å€å—ï¼Ÿ")) {
        return;
    }
    document.getElementById("dateInput").value = "";
    document.getElementById("bookArea").innerHTML = "";
    document.getElementById("pages").value = "";
    document.getElementById("quiz").value = "";
    document.getElementById("homework").value = "";
    document.getElementById("customClassName").value = "";
    document.getElementById("output").textContent = "";
    document.getElementById("output").style.display="none";
    progressCache = [];
    saveCache();
    document.getElementById("importTextArea").value = "";
    document.getElementById("exportTextArea").value = "";
    document.getElementById("exportArea").style.display = "none";
    
    // é‡è¨­ç§‘ç›®é¸å–®
    const subjectSelect = document.getElementById('subject');
    if (subjectSelect) subjectSelect.selectedIndex = 0;
    
    // é‡æ–°è¨­å®šæ—¥æœŸç‚ºä»Šå¤©
    setToday();
    
    console.log("æ‰€æœ‰å…§å®¹å·²æ¸…ç©ºï¼");
}

// ================ åˆå§‹åŒ– (v13.1 ä¿®æ­£) ================
document.addEventListener('DOMContentLoaded', () => {
    try {
        // æª¢æŸ¥ "BOOKS" æ˜¯å¦å·²å®šç¾©
        if (typeof BOOKS === 'undefined') {
            console.error("åš´é‡éŒ¯èª¤ï¼šdata.js æœªè¼‰å…¥æˆ– 'BOOKS' ç‰©ä»¶æœªå®šç¾©ã€‚");
            const bookArea = document.getElementById('bookArea');
            if (bookArea) {
                 bookArea.innerHTML = `<p style="color:red; font-size:0.9rem;"><b>åš´é‡éŒ¯èª¤ï¼š</b><br>1. è«‹ç¢ºèª <code>data.js</code> æª”æ¡ˆåœ¨åŒä¸€å€‹è³‡æ–™å¤¾ã€‚<br>2. è«‹ç¢ºèª <code>data.js</code> å…§éƒ¨èªæ³•æ­£ç¢ºï¼ˆä¾‹å¦‚å¤§æ‹¬è™Ÿ <code>{}</code> æˆ–é€—è™Ÿ <code>,</code> æ˜¯å¦æœ‰èª¤ï¼‰ã€‚<br>3. ä¿®æ­£ <code>data.js</code> æª”æ¡ˆå¾Œï¼Œè«‹ã€Œ<b>é‡æ–°æ•´ç†</b>ã€é é¢ã€‚</p>`;
            }
        }

        if (!document.getElementById("dateInput").value) {
            setToday();
        }
        
        // ç«‹å³æ¸²æŸ“æš«å­˜å’Œæ¨¡æ¿
        renderCache();
        renderTemplates();
        renderSentences();
        
    } catch (e) {
        console.error("åˆå§‹åŒ–æ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼š", e);
        // é é¢ç™¼ç”Ÿåš´é‡éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯ DOM å…ƒç´ ä¸å­˜åœ¨
        document.body.innerHTML = `<div style="padding:20px; text-align:center; background:white; border:2px solid red;"><h1>ç¶²é è¼‰å…¥å¤±æ•—</h1><p>HTML çµæ§‹å¯èƒ½å·²ææ¯€ï¼Œè«‹æª¢æŸ¥ <code>index.html</code> æª”æ¡ˆæ˜¯å¦å®Œæ•´ã€‚</p><p>éŒ¯èª¤è¨Šæ¯ï¼š ${e.message}</p></div>`;
    }
});
</script>

</body>
</html>