<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📘 教學日誌生成器（v12-Patch2 - 作業串接修復版）</title>
<style>
/* 確保手機相容性及美觀 (CSS) */
body { font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:#f5f7fb;margin:0;padding:12px;color:#222;max-width:520px;margin-left:auto;margin-right:auto;}
h1{text-align:center;font-size:1.5rem;margin:12px 0 14px 0;}
.card{background:#fff;border-radius:12px;padding:12px 10px;margin-bottom:12px;
  box-shadow:0 2px 8px rgba(0,20,50,0.06);}
label{font-weight:600;display:block;margin-top:6px;margin-bottom:2px;}
input,select,textarea{width:100%;padding:8px;border-radius:8px;font-size:1rem;
  border:1px solid #ccc;box-sizing:border-box;margin-top:2px;}
textarea{resize:vertical;font-size:1rem;}
button{background:#2563eb;color:white;border:none;border-radius:8px;padding:9px 12px;
  margin-top:8px;cursor:pointer;font-weight:bold;font-size:1rem;margin-right:6px;}
button.danger{background:#ef4444;}button.green{background:#22c55e;}button.orange{background:#f59e0b;}
.section{border-top:1px solid #e5e7eb;margin-top:8px;padding-top:8px;}
.chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;
  margin:4px 3px 3px 0;background:#eef3fc;font-size:0.93rem;cursor:pointer;}
.chip:hover{background:#e2e8f0;}
.output{font-family:"Noto Sans Mono","Consolas",monospace;border-radius:8px;
  line-height:1.6;background:#fff;border:1px solid #e5e7eb;padding:14px 12px;margin-top:10px;
  font-size:1.05rem;white-space:pre-wrap;letter-spacing:0.012em;}
@media (max-width:520px){
  body{padding:4px;}
  .output{font-size:1.09rem;padding:8px 6px;}
  input,select,textarea{font-size:1.01rem;}
}

/* 1. 班級選單三格排版 */
.select-group {
    display: flex;
    gap: 5px;
}
.select-group select {
    width: 33.33%;
    margin-top: 0;
}
.select-group + input {
    margin-top: 5px;
}
/* 3. 按鈕排版 */
.button-row {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.button-row button {
    margin-top: 0;
    margin-right: 0;
    flex-grow: 1;
    width: auto; /* 讓 flex-grow 控制寬度 */
}

/* 核取方塊樣式調整 */
.unit-row{
  display: flex; 
  align-items: flex-start; 
  margin-top: 5px;
  line-height: 1.2; 
}
.unit-row input[type=checkbox]{
  width: auto; 
  margin: 2px 5px 0 0; 
  transform: scale(1.1); 
  flex-shrink: 0; 
}
.unit-label{
  flex: 1; 
  display: inline; 
  margin-top: 0;
}

/* 暫存區樣式 */
#progressCache {
    margin-top: 10px;
    border: 1px dashed #2563eb;
    background: #f0f7ff;
    padding: 10px;
    border-radius: 8px;
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.95rem;
}
#progressCache .cache-item {
    margin-bottom: 5px;
    color: #1e40af;
    line-height: 1.3;
}
</style>
</head>
<body>
<h1>📘 教學日誌生成器（v12-Patch2 - 作業串接修復版）</h1>

<div class="card">
  <label>🏫 班級模板</label>
  <div class="select-group">
    <select id="gradeSelect">
      <option>高一</option>
      <option>高二</option>
      <option>高三</option>
    </select>
    <select id="subjectSelect">
      <option>物理</option>
      <option>化學</option>
      <option>生物</option>
      <option>地科</option>
    </select>
    <select id="classTypeSelect">
      <option>進度</option>
      <option>總複習</option>
    </select>
  </div>
  <input id="customClassName" placeholder="或自訂班級名稱（可空白）">
  <button class="green" onclick="addTemplate()">＋新增模板</button>
  <button onclick="fillTemplate()">填入班名</button>
  <button class="danger" onclick="clearTemplates()">全清模板</button>
  <div id="templateList" style="margin-top:5px;"></div>
</div>

<div class="card">
  <label>🗓️ 日期</label>
  <div style="display:flex;gap:7px;flex-wrap:wrap;">
    <input id="dateInput" placeholder="自動今日">
    <button onclick="setToday()">今天</button>
    <button onclick="setTomorrow()">明天</button>
  </div>
</div>

<div class="card">
  <label>📚 科目 / 進度選單</label>
  <select id="subject" onchange="loadBooks()">
    <option value="">--選科目--</option>
    <option value="physics">物理</option>
    <option value="chemistry">化學</option>
    <option value="biology">生物</option>
    <option value="earth">地科</option>
  </select>
  
  <div id="bookArea" class="section">
    </div>
  
  <div id="cacheArea" class="section" style="text-align: center;">
      <button class="orange" onclick="addToCache()">➡️ 存入暫存區</button>
      <button class="danger" onclick="clearCache(true)">🗑️ 清空暫存</button> 
  </div>
  
  <label style="margin-top: 10px;">💾 已選進度暫存區</label>
  <div id="progressCache">目前無暫存進度。</div>
</div>

<div class="card">
  <div class="section">
    <label>📄 頁數</label>
    <input id="pages" placeholder="例：p.45~52">
    <div style="display:flex;gap:5px;flex-wrap:wrap;">
      <span class="chip" onclick="appendPages('p. ')">p. </span>
      <span class="chip" onclick="appendPages('p. 5~8')">p. 5~8</span>
      <span class="chip" onclick="appendPages('p. 10~15')">p. 10~15</span>
      <span class="chip" onclick="appendPages('p. 25~30')">p. 25~30</span>
      <span class="chip" onclick="appendPages('p. 50~55')">p. 50~55</span>
    </div>
  </div>
  <div class="section">
    <label>🧾 小考</label>
    <input id="quiz" placeholder="例：第2章小考">
  </div>
  <div class="section">
    <label>🏠 回家作業</label>
    <textarea id="homework" rows="2" placeholder="例：講義 p.53~55＋習題"></textarea>
    <div id="sentenceChips"></div>
    <input id="newSentence" placeholder="加到常用作業句庫（右鍵刪）">
    <button class="green" onclick="addSentence()">＋句庫</button>
  </div>
</div>

<div class="card">
  <div class="button-row">
    <button class="orange" onclick="generate()">🚀 產生日誌</button>
    <button onclick="copyOutput()">📋 複製</button>
    <button class="danger" onclick="clearAll(true)">🧹 清空</button>
  </div>
  <div id="output" class="output" style="display:none"></div>
</div>

<script>
// ================ 教材（全科目課程）資料架構 (與 v11 相同) ================
const BOOKS = {
    "physics": {
        "基礎物理(全)": {
            "第1章 科學的態度與方法": {
                "1-1 科學的態度": ["科學的態度"],
                "1-2 科學的方法": ["科學的方法", "國際標準單位制", "基本物理量與導出物理量"],
                "1-3 物理學簡介": ["近代物理科學的發展"]
            },
            "第2章 物質的組成與交互作用": {
                "2-1 物質的組成": ["元素、原子及其存在的證據", "物質三態與原子", "自然現象與原子的交互作用"],
                "2-2 原子的尺度與結構": ["原子的大小及原子核大小", "原子的組成", "原子核的組成", "質子、中子與夸克"],
                "2-3 物質間的基本交互作用": ["重力——萬有引力定律", "電力——庫侖定律", "磁力與磁場", "強交互作用", "弱交互作用", "基本交互作用"]
            },
            "第3章 物體的運動": {
                "3-1 對物體運動的描述": ["伽利略之前學者對物體運動的觀察與思辯", "伽利略對物體運動的研究與思辯歷程", "運動的描述——位移、速度與加速度", "等加速運動"],
                "3-2 牛頓運動定律——運動的原因": ["牛頓三大運動定律", "摩擦力、正向力、彈力、等常見的作用力(日常生活中常見的力)"],
                "3-3 天體運動": ["克卜勒行星運動三大定律發現的歷史背景及內容", "牛頓運動定律結合萬有引力定律可用以解釋克卜勒行星運動定律"]
            },
            "第4章 電與磁的統一": {
                "4-1 電流的磁效應": ["電流磁效應及其應用"],
                "4-2 電磁感應": ["電磁感應及其應用", "電在生活中的應用", "用電安全"],
                "4-3 電與磁的整合": ["馬克士威方程式與電磁波", "電磁波頻譜及其應用"],
                "4-4 光波": ["光微粒說與波動說", "週期波", "光的反射與折射", "惠更斯原理", "光的干涉及繞射"],
                "4-5 都卜勒效應": ["都卜勒效應及其應用"]
            },
            "第5章 能量": {
                "5-1功與能量的形式": ["功", "能量的形式"],
                "5-2 微觀尺度下的能量": ["理想氣體的內能", "克氏溫標"],
                "5-3 能量間的轉換與能量守恆": ["能量的轉換", "焦耳實驗", "能量守恆", "能量轉換效率"],
                "5-4質能互換與核能": ["質能互換", "核分裂", "核能發電與輻射安全", "核融合"]
            },
            "第6章 量子現象": {
                "6-1 光電效應與光的粒子性": ["量子論的誕生——黑體輻射", "光電效應及其應用", "光子"],
                "6-2物質波與電子的波動性": ["物質波", "電子的雙狹縫干涉現象與其波動性"],
                "6-3 波粒二象性": ["波粒二象性", "量子論"],
                "6-4_原子光譜": ["原子光譜", "能階的概念及能階躍遷"]
            }
        },
        "選修物理(I)": {
            "第1章 測量與不確定度": {
                "1-1 不確定度與有效數字": ["真值與不確定度(選修)", "不確定度的A類評估(選修)", "不確定度的B類評估(選修)", "有效數字(選修)", "測量結果的呈現(選修)"],
                "1-2不確定度的組合": ["兩測量值作加減時不確定度的表示(選修)", "兩測量值作乘除時不確定度的表示(選修)"],
                "1-3 因次與因次分析": ["物理量的因次與因次分析法(選修)"]
            },
            "第2章 運動學- 直線運動": {
                "2-1 位置、路徑長與位移": ["位置與坐標軸(選修)", "直線運動的路徑長與位移(選修)"],
                "2-2速度與速率": ["直線運動的平均速度與平均速率(選修)", "直線運動的瞬時速度(選修)", "位置——時間關係圖與速度(選修)", "速度——時間關係圖與位移(選修)"],
                "2-3 加速度": ["直線運動的加速度(選修)", "速度——時間關係圖與加速度(選修)", "加速度——時間關係圖(選修)"],
                "2-4等加速運動": ["一維空間的等加速運動(選修)"],
                "2-5自由落體運動": ["說明鉛直方向的自由落體運動(選修)"],
                "2-6 相對運動": ["說明直線上的相對運動(選修)"],
                "2-7 實驗物體在斜面上的運動": ["實驗:物體在斜面上的運動(選修)"],
                "2-8實驗自由落體": ["實驗:自由落體(選修)"]
            },
            "第3章 運動學-平面運動": {
                "3-1 向量的意義、分解與合成": ["向量的分解(選修)", "向量的加法與減法(選修)", "向量與純量(數)的乘法(選修)"],
                "3-2平面運動的位移、速度與加速度": ["平面運動的位置向量與位移(選修)", "平面運動的平均速度(選修)", "平面運動的瞬時速度(選修)", "平面運動的加速度(選修)"],
                "3-3 水平抛射": ["水平拋射(選修)"],
                "3-4 斜向拋射": ["斜向拋射(選修)"]
            },
            "第4章 牛頓運動定律": {
                "4-1力的向量性質": ["力的種類與向量性質(選修)", "力的合成與分解(選修)", "力的測量與虎克定律(選修)"],
                "4-2牛頓第一運動定律-狀態的意義": ["慣性原理與運動狀態(選修)", "牛頓第一運動定律(選修)", "日常生活中的慣性現象(選修)"],
                "4-3牛頓第二運動定律-狀態的改變": ["加速度與力的關係(選修)", "物體的受力分析(力圖分析)(選修)", "利用牛頓第二運動定律解決問題(解題策略)(選修)"],
                "4-4牛頓第三運動定律作用與反作用": ["作用力與反作用力(選修)", "張力(選修)"],
                "4-5 等速圓周運動與向心力": ["等速圓周運動(選修)", "向心力(選修)"],
                "4-6 簡諧運動": ["等速圓周運動的投影(選修)", "彈簧的振盪運動(選修)", "單擺運動(選修)"],
                "4-7 實驗牛頓第二運動定律": ["實驗:探討力、物體質量與加速度關係(選修)"]
            },
            "第5章 萬有引力定律": {
                "5-1萬有引力定律": ["萬有引力定律(選修)"],
                "5-2 地球表面的重力與重力加速度": ["地球表面的重力與重力加速度(選修)"],
                "5-3行星與人造衛星的運動": ["行星與人造衛星的運動(選修)"],
                "5-4克卜勒定律與萬有引力定律": ["克卜勒定律與萬有引力定律(選修)"]
            }
        },
        "選修物理(II)": {
            "第1章 動量與角動量": {
                "1-1 動量與衝量": ["動量(選修)", "衝量與衝量——動量定理(選修)"],
                "1-2 系統質心運動": ["系統質心運動(選修)"],
                "1-3 動量守恆律": ["動量守恆律(選修)"],
                "1-4角動量與力矩": ["角動量(選修)", "力矩(選修)"],
                "1-5質點的角動量守恆律": ["角動量變化與力矩的關係(選修)", "角動量守恆律(選修)"]
            },
            "第2章 功與動能": {
                "2-1 定力作功": ["力與位移同方向時(選修)", "力與位移不同方向時(選修)"],
                "2-2變力作功": ["變力的功及功之圖示(選修)", "彈力所作的功(選修)"],
                "2-3 動能與功能定理": ["動能(選修)", "功能定理(選修)"],
                "2-4功率": ["功率(選修)"],
                "2-5 重力位能": ["重力位能(選修)"],
                "2-6 重力位能的一般表示式": ["重力位能的一般表示式(選修)"],
                "2-7 彈性位能": ["彈性位能(選修)"],
                "2-8 力學能守恆定律": ["只有保守力作功時的力學能守恆(選修)", "有非保守力作功時的力學能守恆(選修)", "以力學能守恆的角度看簡諧運動(選修)"]
            },
            "第3章 牛頓運動定律的應用": {
                "3-1靜力學與應用實例": ["平移平衡(選修)", "轉動平衡(選修)", "靜力平衡(選修)", "靜力學應用實例(選修)", "靜力學與力(選修)"],
                "3-2 摩擦力": ["靜摩擦力(選修)", "動摩擦力(選修)"],
                "3-3一維碰撞": ["彈性碰撞(選修)", "非彈性碰撞(選修)", "說明碰撞與動量的關係", "探討碰撞的種類(一維碰撞、正面碰撞、彈性碰撞、非彈性碰撞)(選修)", "說明發現中子的實驗為碰撞的應用(選修)"]
            },
            "第4章 熱學": {
                "4-1 絕對溫度與理想氣體方程式": ["氣體的壓力與體積之關係(選修)", "氣體的壓力與溫度之關係(選修)", "氣體的體積與溫度之關係(選修)", "理想氣體方程式(選修)", "壓力與大氣壓力(選修)", "熱平衡(選修)"],
                "4-2氣體運動論": ["氣體壓力與分子運動(選修)", "氣體溫度與分子平均動能(選修)"],
                "4-3氣體分子的速率分布": ["氣體分子的速率分布(選修)"]
            }
        },
        "選修物理(III)": {
            "第1章 波動": {
                "1-1 波的傳播": ["波的性質(選修)", "波的分類(選修)", "繩波的波速(選修)"],
                "1-2 振動與週期波": ["週期波的描述(選修)"],
                "1-3 繩波的反射與透射": ["繩波的反射(選修)", "繩波的透射(選修)"],
                "1-4波的疊加原理": ["波的疊加原理(選修)"],
                "1-5 駐波": ["駐波的形成(選修)", "駐波的條件與名稱(不含弦樂器)(選修)"],
                "1-6惠更斯原理": ["惠更斯原理(選修)"],
                "1-7 水波的干涉": ["水波的干涉(選修)", "水波槽裝置簡介(選修)", "實驗:水波的折射(選修)", "實驗:水波的干涉(選修)", "實驗:水波的繞涉(選修)", "水波的繞射(選修)"]
            },
            "第2章 聲波": {
                "2-1聲波的傳播": ["聲波的性質(選修)", "聲波的描述與傳播(選修)"],
                "2-2 空氣柱的駐波": ["弦樂器的諧音(選修)", "閉管空氣柱的駐波(選修)", "開管空氣柱的駐波(選修)", "音調與音色(選修)"],
                "2-3 共振與共鳴": ["共振與共鳴(選修)", "實驗:氣柱的共鳴(選修)"]
            },
            "第3章 幾何光學": {
                "3-1 光的反射": ["光的反射(選修)"],
                "3-2光的折射與司乃耳定律": ["折射定律與折射率(選修)", "光疏介質與光密介質(選修)", "視深與實深(選修)"],
                "3-3光的全反射": ["光的全反射(選修)", "光的全反射應用(選修)"],
                "3-4光的色散與彩虹成因": ["光的色散現象(選修)", "彩虹的成因(選修)"],
                "3-5 薄透鏡成像與應用": ["薄透鏡的種類、成像與作圖(選修)", "薄透鏡成像公式(選修)", "透鏡的應用(選修)", "實驗:薄透鏡成像(選修)"]
            },
            "第4章 光的干涉與繞射": {
                "4-1光的干涉": ["光的本質-微粒說與波動說(選修)", "光的雙狹縫干涉(選修)", "光的干涉與繞射研究歷程(選修)"],
                "4-2光的繞射": ["光的單狹縫繞射(選修)", "自然界的繞射現象(選修)", "實驗:光的雙狹縫干涉(選修)", "實驗:光的單狹縫繞射(選修)"]
            }
        },
        "選修物理(IV)": {
            "第1章 靜電學": {
                "1-1 庫侖定律": ["庫侖定律(選修)", "疊加原理(選修)"],
                "1-2 電場與電力線": ["電場(選修)", "電力線(選修)", "平行電板間的均匀電場(選修)", "帶電質點在均勻電場中的運動(選修)"],
                "1-3 電位能": ["電位能(選修)", "靜電力作用下的力學能守恆(選修)"],
                "1-4 電位與電位差": ["電位及點電荷附近之電位(選修)", "電位差(選修)", "等電位線與等位體(選修)"],
                "◇第1章 實驗": ["實驗:等電位線與電場(選修)"]
            },
            "第2章 電流的磁效應": {
                "2-1 電生磁": ["電流(選修)", "電流的磁效應(選修)", "必歐沙伐定律(選修)"],
                "2-2載流導線的磁場": ["載流長直導線所生的磁場(選修)", "載流圓形線圈所生的磁場(選修)", "載流螺線管所生的磁場(選修)"],
                "2-3 載流導線在磁場中所受的磁力": ["載流直導線在磁場中的受力(選修)", "平行載流導線間的作用力(選修)", "電動機(選修)"],
                "2-4 帶電質點在磁場中的運動": ["帶電質點在磁場中的受力(選修)", "帶電質點在均勻磁場中的運動(選修)", "帶電質點在均勻磁場中運動的應用(選修)"],
                "◇第2章 實驗": ["實驗:電流天平(選修)"]
            },
            "第3章 電磁感應": {
                "3-1 電磁感應與應電流": ["電磁感應與應電流(選修)"],
                "3-2 冷次定律": ["冷次定律(選修)"],
                "3-3 法拉第電磁感應定律": ["磁通量(選修)", "法拉第電磁感應定律(選修)"],
                "3-4 電磁感應的應用": ["直流電與交流電(選修)", "發電機(選修)", "變壓器(選修)"],
                "3-5 電磁波": ["電磁波的產生和傳播(選修)", "真空中平面電磁波(選修)", "電磁波的偏振現象(選修)"],
                "◇第3章 實驗": ["實驗:電磁波的性質(選修)"]
            }
        },
        "選修物理(V)": {
            "第1章 電流與電路": {
                "1-1 電動勢與電流": ["電動勢與電流(選修)"],
                "1-2 歐姆定律與電阻": ["歐姆定律與電阻(選修)", "影響電阻的因素(選修)"],
                "1-3 電阻的串聯與並聯": ["電阻的串聯與並聯(選修)", "簡單電路(選修)", "電池的內電阻與端電壓(選修)"],
                "1-4 電路中之電荷守恆(電量守恆)與能量守恆": ["電路中之電荷守恆與能量守恆(選修)"],
                "1-5 電功率與電流的熱效應": ["電功率與電流的熱效應(選修)"],
                "◇第1章 實驗": ["實驗:歐姆定律與電路(選修)"]
            },
            "第2章 近代物理的重大發現": {
                "2-1 電子的發現": ["電子的發現(選修)"],
                "2-2密立坎油滴實驗": ["密立坎油滴實驗(選修)"],
                "2-3 X射線": ["X射線(選修)"],
                "2-4 黑體輻射-能量的不連續性": ["黑體輻射(選修)"],
                "2-5 光電效應-輻射的粒子性": ["光電效應(選修)"],
                "◇第2章 實驗": ["實驗:電子的荷質比認識(選修)"]
            },
            "第3章 原子結構與原子核": {
                "3-1拉塞福原子模型與原子光譜": ["拉塞福原子模型(選修)", "原子光譜(選修)"],
                "3-2波耳的氫原子模型": ["波耳的氫原子模型(選修)", "波耳的氫原子能階(選修)"],
                "3-3 物質波與波粒二象性": ["物質波(選修)", "波粒二象性(選修)"],
                "3-4 原子核的組成": ["原子核的組成(選修)"],
                "3-5 原子核衰變與守恆律": ["原子核衰變(選修)", "交互作用與守恆律(選修)"]
            }
        }
    },
    "chemistry": {
        "選修化學 ( I )": {
        "第一章_化學反應與能量": {
            "1-1_氧化還原反應式的平衡": ["氧化數(選修)", "過氧化物與超氧化物(選修)", "氧化數與氧化還原反應(選修)", "氧化數與氧化劑還原劑(選修)", "自身氧化還原反應(選修)", "半反應法均衡化學反應式(選修)", "氧化數法均衡化學反應式(選修)"],
            "1-2_化學反應的限量試劑與產率": ["限量試劑的判斷(選修)", "化學計量與理論產量(選修)", "理論產量與產率(選修)", "分解百分率(選修)", "平衡化學反應式(選修)", "化學反應的類型(選修)"],
            "1-3_各種能量形式的轉換": ["能量的種類與形式(選修)", "光能與光合作用(選修)", "電能與電池(選修)", "能量形式的轉換(選修)"],
            "1-4_反應熱的特性與赫斯定律": ["影響反應熱的因素(選修)", "反應熱的標準狀態(選修)", "化學反應表示法與反應熱的關係(選修)", "赫斯定律的意義及其應用(選修)", "赫斯定律計算(選修)", "反應熱的圖解法(選修)"],
            "1-5_莫耳燃燒熱與莫耳生成熱": ["莫耳生成熱(選修)", "莫耳燃燒熱(選修)", "莫耳溶解熱(選修)", "莫耳中和熱(選修)"]
        },
        "第二章_氣體": {
            "2-1_大氣的分層與氣體的通性": ["大氣層與大氣的組成(選修)", "氣體的通性(選修)", "氣體粒子的運動與溫度(選修)", "氣體壓力與大氣壓力的成因(選修)", "壓力的單位與換算(選修)", "閉口式壓力計(選修)", "開口式壓力計(選修)", "氣體分子的速率分布(選修)"],
            "2-2_氣體三大定律": ["波以耳定律(選修)", "波以耳定律與 J 形管裝置(選修)", "氣體體積與壓力的關係圖(選修)", "波以耳定律與生活中的應用(選修)", "絕對溫度與溫標(選修)", "查理定律(選修)", "氣體體積與溫度的關係圖(選修)", "查理定律與生活中的應用(選修)", "亞佛加厥定律(選修)", "標準溫壓與氣體莫耳體積(選修)", "亞佛加厥定律與生活中的應用(選修)"],
            "2-3_理想氣體": ["理想氣體方程式 PV＝nRT(選修)", "理想氣體常數(選修)", "理想氣體的圖形(選修)", "理想氣體與真實氣體(選修)", "理想氣體方程式的應用 PM＝dRT(選修)"],
            "2-4_分壓": ["莫耳分率(選修)", "混合氣體的平均分子量(選修)", "分壓(選修)", "道耳頓分壓定律的限制(選修)", "道耳頓分壓定律(選修)", "氣體的收集(選修)", "道耳頓的分壓定律的應用(選修)", "氣體的擴散與應用(選修)"]
        },
        "第三章_溶液的性質": {
            "3-1_物質的結構與功能": ["物質依照狀態的分類(選修)", "物質依照導電性的分類(選修)", "物質依照組成的分類(選修)", "物質依照化學性質的分類(選修)", "物質依照溶解度的分類(選修)", "物質依照極性的分類(選修)", "液晶的結構與型態(選修)", "液晶的性質(選修)", "液晶的應用(選修)"],
            "3-2_溶液": ["溶液的形成(選修)", "溶液的狀態(選修)", "溶劑(選修)", "相態的熱能變化(選修)", "溶液的濃度：重量莫耳濃度(選修)", "重量莫耳濃度與其他濃度的換算(選修)", "濃度的比較(選修)", "亨利定律的適用(選修)", "亨利常數(選修)", "影響氣體溶解度的因素(選修)", "亨利定律的計算(選修)", "亨利定律與生活中的關係(選修)"],
            "3-3_蒸氣壓": ["飽和蒸氣壓的動態平衡(選修)", "飽和蒸氣壓的測量(選修)", "影響飽和蒸氣壓的因素：液體的種類(選修)", "影響飽和蒸氣壓的因素：溫度(選修)", "飽和蒸氣壓、揮發性與沸點(選修)", "沸點與正常沸點(選修)", "相對溼度(選修)", "影響飽和蒸氣壓的因素：溶質(選修)", "拉午耳定律：非揮發性溶質(選修)", "蒸氣壓下降量：非揮發性溶質(選修)", "拉午耳定律：揮發性溶質(選修)", "拉午耳定律：蒸氣的組成(選修)", "理想溶液(選修)", "非理想溶液(選修)", "密閉容器內的蒸發平衡：非電解質溶質(選修)"],
            "3-4_溶液的沸點與凝固點": ["溶液的沸點上升：非揮發性溶質(選修)", "溶液的沸點上升度數計算(選修)", "溶液的沸點上升與生活(選修)", "溶液的凝固點下降(選修)", "溶液的凝固點下降度數計算(選修)", "溶液的凝固點下降與生活(選修)"],
            "3-5_溶液的滲透壓": ["半透膜與滲透作用(選修)", "滲透壓與其測定(選修)", "滲透壓的計算(選修)", "滲透作用對生物的影響(選修)", "利用溶液的性質測定溶質分子量(選修)", "逆滲透(選修)"],
            "3-6_水溶液的依數性": ["依數性質(選修)", "凡特何夫因素(選修)", "電解質的依數性質：蒸氣壓下降量(選修)", "電解質的依數性質：密閉容器內的蒸發平衡(選修)", "電解質的依數性質：沸點上升度數(選修)", "電解質的依數性質：凝固點下降度數(選修)", "電解質的依數性質：滲透壓(選修)"],
            "實驗": ["化學反應熱的測定(選修)", "水與酒精的混合溶液體積和溫度的變化(選修)", "凝固點下降的現象(選修)"]
        }
    },
        "選修化學 ( II )": {
        "第一章_原子構造與性質": {
            "1-1_光的性質": ["光的波動性(選修)", "電磁波的種類(選修)", "光的粒子性(選修)"],
            "1-2_原子光譜與波耳的氫原子模型": ["光譜的種類(選修)", "波耳的氫原子模型(選修)", "焰色(選修)", "波耳的氫原子能階(選修)", "氫原子光譜與芮得柏方程式(選修)"],
            "1-3_原子軌域": ["軌道與軌域(選修)", "角量子數(選修)", "磁量子數(選修)", "自旋量子數(選修)", "軌域的種類與形狀(選修)", "軌域的名稱(選修)", "軌域的數目(選修)", "單電子原子軌域的能階高低(選修)", "多電子原子軌域的能階高低(選修)"],
            "1-4_電子組態": ["遞建原理(選修)", "包立不相容原理(選修)", "洪德定則(選修)", "基態的電子組態(選修)", "激發態的電子組態(選修)", "錯誤的電子組態(選修)", "價軌域與價電子(選修)", "原子的電子組態(選修)", "離子的電子組態(選修)"],
            "1-5_元素性質的週期性": ["影響原子半徑的因素(選修)", "半徑的比較(選修)", "游離能定義與測定(選修)", "影響游離能的因素(選修)", "游離能大小的比較(選修)", "電負度(選修)", "電負度的應用(選修)"]
        },
        "第二章_物質的性質與化學鍵": {
            "2-1_化學鍵的種類": ["離子鍵與離子化合物(選修)", "晶格能(選修)", "離子對與離子晶體的能量(選修)", "離子晶體的結構(選修)", "離子晶體的熔點(選修)", "離子晶體的性質(選修)", "電子海與金屬鍵(選修)", "金屬晶體的熔點(選修)", "金屬晶體的性質(選修)", "能帶理論(選修)", "氫分子的形成(選修)", "共振結構(選修)", "路易斯結構(選修)", "網狀固體：鑽石(選修)", "網狀固體：石墨(選修)", "網狀固體：矽(選修)", "網狀固體：二氧化矽(選修)", "網狀固體：其他(選修)"],
            "2-2_單鍵與多鍵": ["鍵數(選修)", "鍵長(選修)", "鍵能(選修)", "σ鍵的形成(選修)", "π鍵的形成(選修)", "σ鍵與π鍵的數目(選修)"],
            "2-3_混成軌域": ["混成軌域：sp3(選修)", "混成軌域：sp2(選修)", "混成軌域：sp(選修)", "混成軌域：dsp3 與 d2sp3(選修)"],
            "2-4_價殼層電子對互斥理論與分子形狀": ["價殼層電子對互斥理論(選修)", "分子形狀：直線(選修)", "分子形狀：平面三角形(選修)", "分子形狀：正四面體(選修)", "分子形狀：雙三角錐(選修)", "分子形狀：正八面體(選修)", "平面形狀的分子和離子(選修)", "鍵角(選修)"],
            "2-5_鍵極性與分子極性": ["鍵的極性(選修)", "鍵的偶極矩(選修)", "影響分子極性的因素(選修)", "極性分子(選修)", "非極性分子(選修)"],
            "2-6_分子間的作用力": ["凡得瓦力(選修)", "偶極—偶極力(選修)", "偶極—誘導偶極力(選修)", "分散力(選修)", "氫鍵的發現(選修)", "氫鍵的形成條件(選修)", "分子間氫鍵(選修)", "分子內氫鍵(選修)", "氫鍵的影響(選修)", "分子間作用力(選修)", "分子的沸點比較(選修)", "分子的熔點比較(選修)", "不同類型晶體的沸點比較(選修)", "不同類型晶體的熔點比較(選修)"]
        },
        "第三章_化學反應速率": {
            "3-1_反應速率": ["反應速率的定義與單位(選修)", "反應速率的表示法(選修)", "反應速率的測量(選修)", "平均速率與瞬時速率(選修)", "反應速率定律式(選修)", "反應級數(選修)", "反應速率常數(選修)", "反應速率常數的單位(選修)", "零級反應(選修)", "一級反應(選修)", "二級反應(選修)", "半生期(選修)"],
            "3-2_碰撞理論": ["化學反應的碰撞理論(選修)", "有效碰撞與低限能(選修)", "有效碰撞與碰撞位向(選修)", "粒子動能分布圖(選修)", "活化複合體(選修)", "活化能(選修)", "活化能與反應速率(選修)", "活化能與反應熱(選修)", "反應能量圖(選修)", "反應機構與速率決定步驟(選修)", "中間產物(選修)"],
            "3-3_影響反應速率的因素": ["影響反應速率的因素：本質(選修)", "影響反應速率的因素：濃度(選修)", "影響反應速率的因素：接觸面積(選修)", "影響反應速率的因素：溫度(選修)", "影響反應速率的因素：催化劑(選修)", "勻相催化反應(選修)", "非勻相催化反應(選修)", "酶催化反應(選修)", "奈米光觸媒(選修)"],
            "實驗": ["實驗_秒錶反應", "秒錶反應(選修)"]
        }
    },
        "選修化學 ( III )": {
        "第一章_化學平衡": {
            "1-1_可逆化學反應與化學平衡": ["可逆反應與不可逆反應(選修)", "化學平衡的條件與特徵(選修)", "化學平衡達成的判斷(選修)"],
            "1-2_平衡常數與計算": ["平衡常數的定義與表示式(選修)", "等效平衡(選修)", "平衡常數的意義(選修)", "影響平衡常數的因素(選修)", "平衡常數 Kc 與 Kp 的關係(選修)", "反應式與平衡常數的關係(選修)", "平衡常數的計算：由濃度(或壓力)求平衡常數(選修)", "平衡常數的計算：由平衡常數求濃度(或壓力)(選修)", "平衡常數 K 值特別大或特別小的計算(選修)", "連續反應平衡常數 K 值的計算(選修)", "反應商與反應進行的方向(選修)", "均相與異相平衡(選修)", "異相平衡的平衡常數表示式(選修)", "異相平衡的平衡計算(選修)"],
            "1-3_勒沙特列原理": ["濃度對平衡的影響(選修)", "壓力或體積對平衡的影響(選修)", "溫度對平衡的影響(選修)", "催化劑對平衡的影響(選修)", "勒沙特列原理的應用：哈柏法製氨(選修)", "勒沙特列原理的應用：甲烷的製備(選修)", "勒沙特列原理的應用：其他(選修)"],
            "1-4_溶解平衡與溶度積的關係": ["溶解平衡(選修)", "溶度積常數的表示法(選修)", "溶度積 Ksp 與溶解度 s 的關係(選修)", "由溶解度求溶度積(選修)", "由溶度積求溶解度(選修)", "離子積(選修)", "同離子效應的溶解平衡(選修)"],
            "1-5_離子之沉澱、分離及確認": ["選擇性沉澱(選修)", "離子化合物的溶解度與沉澱表(選修)", "常見沉澱與離子的顏色(選修)", "混合離子的分離(選修)", "沉澱的再溶解(選修)"]
        },
        "第二章_酸鹼反應": {
            "2-1_酸與鹼的命名": ["酸的命名(選修)", "鹼的命名(選修)"],
            "2-2_布-洛酸鹼學說": ["布–洛酸鹼學說(選修)", "共軛酸鹼對(選修)", "酸鹼的相對強度(選修)", "布–洛酸鹼的反應趨勢(選修)", "兩性物質(選修)", "布–洛酸鹼學說的比較(選修)"],
            "2-3_酸鹼的解離平衡": ["水的解離平衡(選修)", "弱酸的解離常數 Ka(選修)", "弱酸的解離百分比(選修)", "弱鹼的解離常數 Kb(選修)", "弱鹼的解離百分比(選修)", "酸鹼的同離子效應(選修)", "多質子酸(選修)", "多質子酸的解離常數 Ka(選修)", "水溶液中的電荷平衡(選修)"],
            "2-4_鹽類": ["鹽的定義(選修)", "鹽的形成(選修)", "鹽的種類：正鹽(選修)", "鹽的種類：酸式鹽(選修)", "鹽的種類：複鹽(選修)", "鹽的命名(選修)", "鹽的酸鹼性(選修)", "鹽的水解(選修)"],
            "2-5_緩衝溶液": ["緩衝溶液的性質(選修)", "緩衝溶液的組成(選修)", "緩衝溶液的配製(選修)", "緩衝溶液的計算(選修)", "緩衝溶液的應用(選修)"],
            "2-6_酸鹼滴定與滴定曲線": ["酸鹼滴定(選修)", "當量點(選修)", "滴定曲線(選修)", "酸鹼指示劑(選修)", "酸鹼指示劑的變色範圍(選修)"]
        },
        "第三章_電化學": {
            "3-1_氧化還原反應": ["氧化數與氧化劑還原劑的比較(選修)", "常見的氧化劑(選修)", "常見的還原劑(選修)", "氧化還原反應的判斷(選修)", "氧化還原反應式的平衡(選修)"],
            "3-2_電池與電解": ["伽凡尼電池與電解池的比較(選修)", "電池的結構(選修)", "電極的種類(選修)", "半電池反應(選修)", "標準還原電位(選修)", "電位計(選修)", "鹽橋(選修)", "電池的種類：一次電池(選修)", "電池的種類：二次電池(選修)", "電池的種類：燃料電池(選修)", "電解的原理(選修)", "電解的產物預測(選修)"],
            "3-3_法拉第電解定律": ["法拉第電解定律(選修)", "法拉第常數(選修)", "法拉第電解定律的計算(選修)"],
            "3-4_能斯特方程式": ["能斯特方程式的推導(選修)", "能斯特方程式的應用(選修)"]
        },
        "實驗": ["化學反應熱的測定(選修)", "水與酒精的混合溶液體積和溫度的變化(選修)", "凝固點下降的現象(選修)"]
    },
        "選修化學 ( IV )": {
        "第一章_有機化合物": {
            "1-1_有機化合物的分類與命名": ["有機化合物的定義(選修)", "碳的特性(選修)", "有機化合物的來源(選修)", "有機化合物的分類(選修)", "官能基(選修)", "飽和烴：烷類(選修)", "烷類的命名(選修)", "不飽和烴：烯類(選修)", "烯類的命名(選修)", "不飽和烴：炔類(選修)", "炔類的命名(選修)", "環烷與環烯(選修)", "芳香烴：苯(選修)", "苯的衍生物：甲苯、二甲苯(選修)", "苯的衍生物：酚(選修)"],
            "1-2_有機化合物的性質與反應": ["烷類的性質(選修)", "烷類的反應(選修)", "烯類的性質(選修)", "烯類的反應(選修)", "炔類的性質(選修)", "炔類的反應(選修)", "芳香烴的性質(選修)", "芳香烴的反應(選修)", "醇、醚、醛、酮的性質(選修)", "醇、醚、醛、酮的反應(選修)", "羧酸與酯的性質(選修)", "羧酸與酯的反應(選修)", "胺與醯胺的性質(選修)", "胺與醯胺的反應(選修)"],
            "1-3_立體異構物與掌性": ["立體異構物(選修)", "幾何異構物(選修)", "光學異構物(選修)", "掌性碳原子(選修)", "對映異構物(選修)", "非對映異構物(選修)", "旋光度與外消旋混合物(選修)"]
        },
        "第二章_高分子化合物": {
            "2-1_高分子化合物的種類與特性": ["高分子化合物的定義(選修)", "單體與聚合物(選修)", "高分子化合物的分類(選修)", "高分子化合物的特性(選修)"],
            "2-2_高分子化合物的合成與應用": ["加成聚合反應(選修)", "縮合聚合反應(選修)", "天然高分子化合物(選修)", "合成高分子化合物(選修)", "高分子化合物的應用：塑膠(選修)", "高分子化合物的應用：纖維(選修)", "高分子化合物的應用：橡膠(選修)"]
        },
        "第三章_生活中的化學": {
            "3-1_日常用品與食品化學": ["清潔劑的原理(選修)", "肥皂與合成清潔劑(選修)", "化妝品的成分與作用(選修)", "食品添加物(選修)", "食品的酸鹼性與保存(選修)", "食品的營養成分(選修)"],
            "3-2_藥物與健康化學": ["藥物的分類與作用(選修)", "常見的藥物：止痛劑、抗生素(選修)", "藥物的濫用與管制(選修)", "健康食品與營養補充品(選修)"],
            "3-3_環境化學與綠色化學": ["水汙染與防治(選修)", "空氣汙染與防治(選修)", "土壤汙染與防治(選修)", "綠色化學的原則(選修)", "綠色化學的應用(選修)"]
        },
        "第四章_化學與社會": {
            "4-1_化學與能源": ["能源的種類(選修)", "化石燃料(選修)", "核能(選修)", "再生能源：太陽能、風力、水力(選修)"],
            "4-2_化學與材料": ["新興材料：奈米材料(選修)", "新興材料：半導體材料(選修)", "新興材料：超導體材料(選修)"],
            "4-3_化學與科技": ["化學與資訊科技(選修)", "化學與生物科技(選修)", "化學與環境科技(選修)"]
        },
        "實驗": ["示範實驗_萃取、蒸餾及薄層層析", "萃取、蒸餾及薄層層析", "實驗1_溶解度的測定（溶解度曲線和結晶）", "溶解度的測定（溶解度曲線和結晶）", "實驗2_酸鹼指示劑", "酸鹼指示劑(實驗)", "實驗3_界面活性劑的效應", "界面活性劑的效應"]
    },
        "選修化學 ( V )": {
        "第一章_分析化學": {
            "1-1_化學計量與滴定分析": ["化學計量(選修)", "滴定分析的原理(選修)", "滴定分析的計算(選修)"],
            "1-2_光譜分析": ["光譜的種類(選修)", "原子吸收光譜(選修)", "紫外光/可見光光譜(選修)", "紅外光光譜(選修)"],
            "1-3_層析分離技術": ["層析法的原理(選修)", "薄層層析(選修)", "管柱層析(選修)", "氣相層析(選修)", "液相層析(選修)"]
        },
        "第二章_無機化學": {
            "2-1_過渡金屬元素": ["過渡金屬元素的特性(選修)", "錯合物的結構與命名(選修)", "錯合物的應用(選修)"],
            "2-2_主族元素": ["鹼金屬與鹼土金屬(選修)", "硼族、碳族、氮族元素(選修)", "氧族、鹵素、鈍氣(選修)"]
        },
        "第三章_生命化學": {
            "3-1_醣類": ["醣類的分類與結構(選修)", "單醣、雙醣、多醣(選修)", "醣類的功能(選修)"],
            "3-2_脂質": ["脂質的分類與結構(選修)", "脂肪、磷脂、類固醇(選修)", "脂質的功能(選修)"],
            "3-3_蛋白質": ["胺基酸的結構與分類(選修)", "胜肽鍵與蛋白質的結構(選修)", "蛋白質的功能(選修)"],
            "3-4_核酸": ["核酸的結構(選修)", "DNA與RNA(選修)", "核酸的功能(選修)"]
        }
    },
        "基礎化學 ( 全 )": {
            "第1章 物質的組成": {
                "1-1 物質的分類": ["純物質與混合物(基礎)", "元素與化合物(基礎)", "分離與純化(基礎)"],
                "1-2 原子與分子": ["原子學說(基礎)", "原子結構(基礎)", "同位素(基礎)", "分子與化學式(基礎)"],
                "1-3 化學計量": ["莫耳(基礎)", "原子量與分子量(基礎)", "化學反應與質量守恆(基礎)", "化學反應的計量(基礎)"]
            },
            "第2章 化學鍵結": {
                "2-1 化學鍵的種類": ["離子鍵(基礎)", "共價鍵(基礎)", "金屬鍵(基礎)"],
                "2-2 物質的結構與性質": ["離子化合物的性質(基礎)", "分子化合物的性質(基礎)", "金屬的性質(基礎)", "網狀共價固體(基礎)"]
            },
            "第3章 溶液": {
                "3-1 溶液的形成與濃度": ["溶解度(基礎)", "影響溶解度的因素(基礎)", "溶液的濃度表示法(基礎)"],
                "3-2 溶液的性質": ["蒸氣壓下降(基礎)", "沸點上升(基礎)", "凝固點下降(基礎)", "滲透壓(基礎)"]
            },
            "第4章 酸鹼鹽": {
                "4-1 酸鹼的定義與性質": ["酸鹼的定義(基礎)", "酸鹼的性質(基礎)", "酸鹼的濃度與 pH 值(基礎)"],
                "4-2 酸鹼反應與鹽類": ["中和反應(基礎)", "鹽類的種類與性質(基礎)", "緩衝溶液(基礎)"]
            },
            "第5章 氧化還原": {
                "5-1 氧化數與氧化還原反應": ["氧化數(基礎)", "氧化還原反應的判斷(基礎)", "常見的氧化劑與還原劑(基礎)"],
                "5-2 電化學": ["電池(基礎)", "電解(基礎)", "法拉第電解定律(基礎)"]
            }
        }
    },
    "biology": {
        "基礎生物(上)": {
            "第1章 細胞": {
                "1-1 生命的特性": ["生命的現象(基礎)", "生物的組成層次(基礎)"],
                "1-2 細胞的構造": ["細胞的發現(基礎)", "細胞學說(基礎)", "細胞膜(基礎)", "胞器(基礎)"],
                "1-3 細胞的代謝": ["酵素(基礎)", "細胞呼吸(基礎)", "光合作用(基礎)"]
            },
            "第2章 遺傳": {
                "2-1 遺傳物質": ["染色體與基因(基礎)", "DNA結構(基礎)"],
                "2-2 遺傳法則": ["孟德爾遺傳法則(基礎)", "性聯遺傳(基礎)"]
            },
            "第3章 演化": {
                "3-1 演化的證據": ["化石證據(基礎)", "解剖學證據(基礎)"],
                "3-2 演化的機制": ["天擇說(基礎)", "物種的形成(基礎)"]
            }
        }
    },
    "earth": {
        "基礎地球科學(全)": {
            "第1章 宇宙": {
                "1-1 宇宙的形成與恆星": ["宇宙的起源(基礎)", "恆星的誕生與死亡(基礎)", "星系(基礎)"],
                "1-2 太陽系與行星": ["太陽系的形成(基礎)", "行星的分類(基礎)"]
            },
            "第2章 地球": {
                "2-1 地球的結構": ["地球的內部構造(基礎)", "板塊構造學說(基礎)"],
                "2-2 地球的歷史": ["地質年代表(基礎)", "地球的演變(基礎)"]
            },
            "第3章 大氣與海洋": {
                "3-1 大氣的結構與天氣": ["大氣的分層(基礎)", "天氣系統(基礎)"],
                "3-2 海洋與水循環": ["海洋的結構(基礎)", "水循環與洋流(基礎)"]
            }
        }
    }
};

// ================ JS 變數與輔助函數 ================
let progressCache = JSON.parse(localStorage.getItem('teachingLogCache')) || [];

function saveCache() {
    localStorage.setItem('teachingLogCache', JSON.stringify(progressCache));
    renderCache();
}

function renderCache() {
    const cacheDiv = document.getElementById('progressCache');
    if (progressCache.length === 0) {
        cacheDiv.innerHTML = '目前無暫存進度。';
        return;
    }

    // 將暫存區的進度依路徑重新分組 (因為暫存時是單條儲存)
    const groupedCache = new Map();
    progressCache.forEach(item => {
        const path = item.path;
        if (groupedCache.has(path)) {
            // 避免重複加入 topic
            if (!groupedCache.get(path).includes(item.topic)) {
                 groupedCache.get(path).push(item.topic);
            }
        } else {
            groupedCache.set(path, [item.topic]);
        }
    });

    let html = '';
    groupedCache.forEach((topics, path) => {
        const combinedTopics = topics.join(' ＋ ');
        const pathParts = path.split(' / ');
        const lastPart = pathParts.slice(-1)[0];
        
        // 如果只有一個 topic 且 topic 等於路徑最後一部分（章/節/冊），則只顯示路徑
        const isPathOnly = topics.length === 1 && topics[0] === lastPart;
        
        if (isPathOnly) {
             html += `<div class="cache-item">‧ ${path}</div>`;
        } else {
             html += `<div class="cache-item">‧ ${path} <br> (${combinedTopics})</div>`;
        }
    });
    
    cacheDiv.innerHTML = html;
}

// ============== 核心修改區: addToCache() 移除勾選限制，改為分層級存入 ==============
function addToCache() {
    let itemsToCache = [];
    const checks = document.querySelectorAll("#topicArea input[type=checkbox]:checked");
    
    // 1. 優先處理有勾選重點的情況 (最高層級，最細節)
    if (checks.length > 0) {
        checks.forEach(cb => {
            const path = cb.value; 
            const topic = cb.dataset.topicName; 
            itemsToCache.push({ path: path, topic: topic });
            cb.checked = false; // 清空當前頁面勾選狀態
        });
        console.log(`已將 ${checks.length} 個勾選重點存入暫存區！`);
    } else {
        // 2. 處理沒有勾選重點，但選單有選取的情況
        const subjectSelect = document.getElementById('subject');
        const subjectKey = subjectSelect ? subjectSelect.value : '';
        const subjectName = subjectSelect ? subjectSelect.options[subjectSelect.selectedIndex].text : '';
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const sectionSelect = document.getElementById('sectionSelect');
        
        const bookName = bookSelect ? bookSelect.value : '';
        const chapterName = chapterSelect ? chapterSelect.value : '';
        const sectionName = sectionSelect ? sectionSelect.value : '';

        let progressPath = '';
        let progressName = '';

        if (subjectKey) {
            if (sectionName) {
                // 2.1. 選到小節: 存入 小節 名稱
                progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
                progressName = sectionName;
                
            } else if (chapterName) {
                // 2.2. 選到章節: 存入 章節 名稱
                progressPath = `${bookName} / ${chapterName}`;
                progressName = chapterName;
                
            } else if (bookName) {
                // 2.3. 選到冊別: 存入 冊別 名稱
                progressPath = `${bookName}`;
                progressName = bookName;
                
            } else {
                // 2.4. 只選到科目 (依照 V11 第 5 點要求，科目如果只選擇了 物理 則輸出物理到暫存區)
                // 強化邏輯：如果只選科目，且該科目有冊別，則將所有冊別名稱作為 path，科目名稱作為 topic 存入
                if (BOOKS[subjectKey]) {
                    Object.keys(BOOKS[subjectKey]).forEach(bName => {
                        // 這裡使用 冊別名 作為 path，科目名作爲 topic，符合輸出要求但避免單純存入科目名。
                        itemsToCache.push({ path: bName, topic: subjectName }); 
                    });
                     if (itemsToCache.length > 0) {
                         console.log(`偵測到只選科目，已將 ${subjectName} 涉及的 ${itemsToCache.length} 個冊別作為進度存入暫存區！`);
                         
                     }
                    // 執行完畢，不需再繼續
                    itemsToCache.forEach(item => {
                        const isDuplicate = progressCache.some(p => p.path === item.path && p.topic === item.topic);
                        if (!isDuplicate) progressCache.push(item);
                    });
                    saveCache(); 
                    return; 
                }
            }
        }
        
        // 3. 將最高層級的選擇加入 toCache 列表
        if (progressPath && progressName) {
            itemsToCache.push({ path: progressPath, topic: progressName });
            console.log(`已將選單最高層級：${progressPath} 存入暫存區！`);
        }
        
        // 4. 如果沒有任何選取 (包括科目)，則提示
        if (itemsToCache.length === 0) {
            console.log("請在上方選單選擇進度，或勾選重點單元。");
            return;
        }
    }

    // 5. 統一寫入暫存區
    let addedCount = 0;
    itemsToCache.forEach(item => {
        const isDuplicate = progressCache.some(p => p.path === item.path && p.topic === item.topic);
        if (!isDuplicate) {
            progressCache.push(item);
            addedCount++;
        }
    });

    if (addedCount > 0) {
        saveCache(); // 保存並重新渲染
        // 如果是多個重點，訊息已在前面輸出
        if (checks.length === 0 && itemsToCache.length === 1) {
             console.log("進度已存入暫存區。");
        } else if (checks.length === 0 && itemsToCache.length > 1) {
             // 處理只選科目的多個冊別情況
        } else {
             // 處理多個重點的情況
        }
    } else if (checks.length > 0) {
        // 有勾選，但都重複
         console.log("您勾選的重點已全部在暫存區中。");
    } else {
        // 有選單選項，但重複
        console.log("您選擇的進度已在暫存區中。");
    }
}


// 增加一個參數以控制是否顯示警示窗
function clearCache(showConfirm = false) {
    if (showConfirm) {
        if (!confirm("確定要清空所有暫存區的進度嗎？")) {
            return;
        }
    }
    progressCache = [];
    saveCache();
    console.log("暫存區已清空！");
}

// 2. 頁數常用選項功能
function appendPages(text) {
  const pagesInput = document.getElementById("pages");
  pagesInput.value = text.trim();
}

// ================ 級聯選單功能 (與 v11 相同) ================
function loadBooks() {
    const subjectKey = document.getElementById('subject').value;
    const bookArea = document.getElementById('bookArea');
    bookArea.innerHTML = '';
    
    if (!subjectKey || !BOOKS[subjectKey]) {
        return;
    }

    const books = Object.keys(BOOKS[subjectKey]);
    if (books.length === 0) return;

    let html = '<label>📖 冊別</label>';
    html += `<select id="bookSelect" onchange="loadChapters()">
                <option value="">--選冊別--</option>
                ${books.map(b => `<option value="${b}">${b}</option>`).join('')}
             </select>`;
    
    html += '<div id="chapterSelectArea" style="margin-top:10px;"></div>';
    html += '<div id="sectionSelectArea" style="margin-top:10px;"></div>';
    html += '<div id="topicArea" style="margin-top:10px;"></div>';

    bookArea.innerHTML = html;
}

function loadChapters() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const bookName = bookSelect ? bookSelect.value : '';

    const chapterArea = document.getElementById('chapterSelectArea');
    chapterArea.innerHTML = '';
    document.getElementById('sectionSelectArea').innerHTML = '';
    document.getElementById('topicArea').innerHTML = ''; 

    if (!bookName) return;

    const chapters = Object.keys(BOOKS[subjectKey][bookName]);
    
    let html = '<label>📑 章節</label>';
    html += `<select id="chapterSelect" onchange="loadSections()">
                <option value="">--選章節--</option>
                ${chapters.map(c => `<option value="${c}">${c}</option>`).join('')}
             </select>`;
    
    chapterArea.innerHTML = html;
}

function loadSections() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const bookName = bookSelect ? bookSelect.value : '';
    const chapterName = chapterSelect ? chapterSelect.value : '';

    const sectionArea = document.getElementById('sectionSelectArea');
    sectionArea.innerHTML = '';
    document.getElementById('topicArea').innerHTML = ''; 
    
    if (!chapterName) return;
    
    const sections = Object.keys(BOOKS[subjectKey][bookName][chapterName]);
    
    let html = '<label>📝 小節</label>';
    html += `<select id="sectionSelect" onchange="loadTopics()">
                <option value="">--選小節--</option>
                ${sections.map(s => `<option value="${s}">${s}</option>`).join('')}
             </select>`;
    
    sectionArea.innerHTML = html;
}

function loadTopics() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const sectionSelect = document.getElementById('sectionSelect');
    
    const bookName = bookSelect ? bookSelect.value : '';
    const chapterName = chapterSelect ? chapterSelect.value : '';
    const sectionName = sectionSelect ? sectionSelect.value : '';
    
    const topicArea = document.getElementById('topicArea');
    topicArea.innerHTML = '';

    if (!sectionName) return;

    const topics = BOOKS[subjectKey][bookName][chapterName][sectionName];

    let html = '<label>✅ 今日進度 (可複選)</label>';
    html += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 8px; border-radius: 8px;">';
    
    topics.forEach((topic, index) => {
        const progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
        const uniqueId = `topic-${sectionName.replace(/\s/g, '_')}-${index}`;
        html += `<div class="unit-row">
                    <input type="checkbox" id="${uniqueId}" value="${progressPath}" data-topic-name="${topic}">
                    <label for="${uniqueId}" class="unit-label">${topic}</label>
                 </div>`;
    });
    
    html += '</div>';
    topicArea.innerHTML = html;
}


function formatDate(date) {
  const d = new Date(date);
  const year = d.getFullYear();
  const month = ('0' + (d.getMonth() + 1)).slice(-2);
  const day = ('0' + d.getDate()).slice(-2);
  return `${year}-${month}-${day}`;
}
function setToday(){
  document.getElementById("dateInput").value = formatDate(new Date());
}
function setTomorrow(){
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById("dateInput").value = formatDate(tomorrow);
}

// ================ 模板功能 (移除警示窗) ================
let templates = JSON.parse(localStorage.getItem('teachingLogTemplates')) || [];
function saveTemplates() { localStorage.setItem('teachingLogTemplates', JSON.stringify(templates)); }
function renderTemplates() {
  const list = document.getElementById("templateList");
  list.innerHTML = templates.map((t, i) => 
    `<span class="chip" onclick="applyTemplate('${t}')" oncontextmenu="deleteTemplate(${i}, true); return false;">${t}</span>`
  ).join('');
}
function addTemplate() {
  const grade = document.getElementById("gradeSelect").value || "";
  const type = document.getElementById("classTypeSelect").value || "";
  const subj = document.getElementById("subjectSelect").value || "";
  const custom = document.getElementById("customClassName").value.trim() || "";
  // 修正組合順序為 級別 + 科目 + 類型
  const name = custom || `${grade}${subj}${type}`; 
  if (name && !templates.includes(name)) {
    templates.push(name);
    saveTemplates();
    renderTemplates();
  }
}
function applyTemplate(name) {
  document.getElementById("customClassName").value = name;
}
function deleteTemplate(index, showConfirm = false) {
    if (showConfirm) {
        if (!confirm(`確定刪除模板：${templates[index]} 嗎？`)) {
            return;
        }
    }
    templates.splice(index, 1);
    saveTemplates();
    renderTemplates();
    console.log(`模板已刪除。`);
}
function fillTemplate() {
  const className = (() => {
    const grade = document.getElementById("gradeSelect").value || "";
    const type = document.getElementById("classTypeSelect").value || "";
    const subj = document.getElementById("subjectSelect").value || "";
    const custom = document.getElementById("customClassName").value.trim();
    if (custom) return custom;
    // 修正組合順序為 級別 + 科目 + 類型
    const combo = grade + subj + type;
    return combo; 
  })();
  document.getElementById("customClassName").value = className;
}
function clearTemplates(showConfirm = false) {
    if (showConfirm) {
        if (!confirm("確定清空所有班級模板嗎？")) {
            return;
        }
    }
    templates = [];
    saveTemplates();
    renderTemplates();
    console.log("所有班級模板已清空。");
}
renderTemplates();

// ================ 作業句庫功能 (v12-Patch2: 修正 appendHomework 語法錯誤) ================
let sentences = JSON.parse(localStorage.getItem('homeworkSentences')) || ["講義 p.X~Y", "習題卷", "考卷訂正", "複習指定範圍"];
function saveSentences() { localStorage.setItem('homeworkSentences', JSON.stringify(sentences)); }
function renderSentences() {
  const list = document.getElementById("sentenceChips");
  list.innerHTML = sentences.map((s, i) => 
    `<span class="chip" onclick="appendHomework('${s}')" oncontextmenu="deleteSentence(${i}, true); return false;">${s}</span>`
  ).join('');
}
function addSentence() {
  const newS = document.getElementById("newSentence").value.trim();
  if (newS && !sentences.includes(newS)) {
    sentences.push(newS);
    saveSentences();
    renderSentences();
    document.getElementById("newSentence").value = '';
  }
}

// *** 修復後的 appendHomework 函數 (V12-Patch2 核心修改) ***
function appendHomework(s) {
  const homework = document.getElementById("homework");
  if (homework.value.trim() === '') {
    homework.value = s;
  } else if (!homework.value.includes(s)) {
    // 修正了 homework.endsWith() 錯誤，現在改為 homework.value.endsWith()
    homework.value += (homework.value.endsWith('。') || homework.value.endsWith('、') || homework.value.endsWith('！') || homework.value.endsWith('？') ? '' : '＋') + s;
  }
}
// *************************************************

function deleteSentence(index, showConfirm = false) {
    if (showConfirm) {
        if (!confirm(`確定刪除句庫：${sentences[index]} 嗎？`)) {
            return;
        }
    }
    sentences.splice(index, 1);
    saveSentences();
    renderSentences();
    console.log("句庫項目已刪除。");
}
renderSentences();

// ================ 產生日誌功能 (v12-Patch1 優化，無功能變動) ================
function generate() {
    // 1. 抓取所有值並進行 trim()
    const customClassName = document.getElementById("customClassName").value.trim();
    const date = document.getElementById("dateInput").value.trim();
    const pages = document.getElementById("pages").value.trim();
    const quiz = document.getElementById("quiz").value.trim();
    const homework = document.getElementById("homework").value.trim();
    
    // 1.1. 檢查是否有當前選中的重點：自動存入暫存區 (不給提示)
    const currentChecks = document.querySelectorAll("#topicArea input[type=checkbox]:checked");
    let tempCacheFromChecks = [];
    if (currentChecks.length > 0) {
        console.log(`偵測到 ${currentChecks.length} 個勾選重點，自動存入暫存區。`);
        currentChecks.forEach(cb => {
            const path = cb.value; 
            const topic = cb.dataset.topicName; 
            const newItem = { path: path, topic: topic };
            
            // 檢查是否已存在 (避免重複加入)
            const isDuplicate = progressCache.some(item => item.path === path && item.topic === topic);

            if (!isDuplicate) {
                progressCache.push(newItem);
            }
            cb.checked = false; // 清空當前頁面勾選狀態
        });
        saveCache(); // 保存並重新渲染暫存區
    }

    const className = (() => {
        if (customClassName) return customClassName;
        const grade = document.getElementById("gradeSelect").value || "";
        const type = document.getElementById("classTypeSelect").value || "";
        const subj = document.getElementById("subjectSelect").value || "";
        // 修正組合順序為 級別 + 科目 + 類型
        const combo = grade + subj + type;
        return combo.trim();
    })(); 

    // 2. 處理進度：優先使用暫存區 (progressCache) 中的數據
    
    let progressToOutput = []; // 儲存最終要輸出的進度項目
    
    if (progressCache.length > 0) {
        // 2.1. A. 暫存區有資料：使用暫存區 (progressCache)
        progressToOutput = [...progressCache]; // 複製一份，避免直接修改
        console.log("進度來源：暫存區");
    } else {
        // 2.1. B. 暫存區無資料：嘗試從選單中抓取最高層級進度 (同 addToCache 邏輯，避免重複)
        const subjectSelect = document.getElementById('subject');
        const subjectKey = subjectSelect ? subjectSelect.value : '';
        const subjectName = subjectSelect ? subjectSelect.options[subjectSelect.selectedIndex].text : '';
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const sectionSelect = document.getElementById('sectionSelect');
        
        const bookName = bookSelect ? bookSelect.value : '';
        const chapterName = chapterSelect ? chapterSelect.value : '';
        const sectionName = sectionSelect ? sectionSelect.value : '';

        let progressPath = '';
        let progressName = '';

        if (sectionName) {
            // 選到小節 (最高層級：小節)
            progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
            progressName = sectionName;
            
        } else if (chapterName) {
            // 只選到章節 (最高層級：章節)
            progressPath = `${bookName} / ${chapterName}`;
            progressName = chapterName;
            
        } else if (bookName) {
            // 只選到冊別 (最高層級：冊別)
            progressPath = `${bookName}`;
            progressName = bookName;
            
        } else if (subjectKey) {
            // 只選科目: 輸出科目名稱
            // 由於這時沒有明確的 path，為了輸出，我們取所有冊別作為 path，科目名作為 topic
            if (BOOKS[subjectKey]) {
                Object.keys(BOOKS[subjectKey]).forEach(bName => {
                     progressToOutput.push({ path: bName, topic: subjectName }); 
                });
            }
            console.log("進度來源：選單 (只選科目)");
        }
        
        // 將最高層級的單一選擇加入 output 列表
        if (progressPath && progressName) {
             progressToOutput.push({ path: progressPath, topic: progressName });
             console.log("進度來源：選單 (最高層級)");
        }
        
    }
    
    // 2.2. 將進度依路徑重新分組 (不論來源是暫存區還是自動抓取)
    const groupedProgress = new Map();
    progressToOutput.forEach(item => {
      const path = item.path;
      const topic = item.topic || path.split(' / ').pop(); // 如果沒有 topic，使用路徑的最後一部分
      
      if (groupedProgress.has(path)) {
        if (!groupedProgress.get(path).includes(topic)) {
             groupedProgress.get(path).push(topic);
        }
      } else {
        groupedProgress.set(path, [topic]);
      }
    });

    const progressLines = [];
    
    // 2.3. 遍歷 Map 輸出，使用緊湊格式
    groupedProgress.forEach((topics, path) => {
      // 輸出格式: ‧ 冊別 / 章節 / 小節 (重點1 ＋ 重點2)
      const combinedTopics = topics.join(' ＋ ');
      const parts = path.split(' / ');
      const lastPart = parts.slice(-1)[0];
      
      // 判斷是否為「單一」進度，且重點名稱與路徑末端名稱相同 (或為只選科目的情況)
      const isSingleMatch = (topics.length === 1 && (topics[0] === lastPart || topics[0] === document.getElementById('subject').options[document.getElementById('subject').selectedIndex].text));

      if (isSingleMatch) {
         progressLines.push(`‧ ${path}`);
      } else {
         progressLines.push(`‧ ${path} (${combinedTopics})`);
      }
      
    });

    const progressOutput = progressLines.join('\n');


    // 3. 組合最終結果 (空值完全不顯示區塊，區塊間只有一個換行符)
    let result = [];

    // 班級
    if (className) {
        result.push(`🏫 班級\n${className}`);
    }

    // 日期
    if (date) {
        result.push(`🗓️ 日期\n${date}`);
    }

    // 進度 (從暫存區或選單取出，可空)
    if (progressOutput) {
        result.push(`📘 今日進度\n${progressOutput}`);
    }

    // 頁數
    if (pages) {
        result.push(`📄 頁數\n${pages}`);
    }

    // 小考
    if (quiz) {
        result.push(`🧾 小考\n${quiz}`);
    }

    // 作業
    if (homework) {
        result.push(`🏠 作業\n${homework}`);
    }
    
    // 4. 輸出
    const out = document.getElementById("output");
    out.style.display="block";
    // 使用 \n 分隔每個區塊 (實現區塊間無空行)
    out.textContent = result.join('\n').trim(); 
    out.scrollIntoView({behavior:"smooth"});
    
    // 產生後清空暫存區
    if (progressCache.length > 0) {
        // 只要使用了暫存區的內容，就清空
        progressCache = [];
        saveCache(); // 清空並保存
    }
}


function copyOutput(){
    const text=document.getElementById("output").textContent;
    if(!text) {
        console.log("請先產生內容");
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        console.log("已複製到剪貼簿！"); // 使用 console.log 替代 alert
    }).catch(err => {
        console.error('複製失敗:', err);
    });
}

// 增加一個參數以控制是否顯示警示窗
function clearAll(showConfirm = false){
    if (showConfirm) {
        if (!confirm("確定清空所有輸入框內容與暫存區嗎？")) {
            return;
        }
    }
    document.getElementById("dateInput").value = "";
    document.getElementById("bookArea").innerHTML = ""; 
    document.getElementById("pages").value = "";
    document.getElementById("quiz").value = "";
    document.getElementById("homework").value = "";
    document.getElementById("customClassName").value = "";
    document.getElementById("output").textContent = "";
    document.getElementById("output").style.display="none";
    
    // 清空暫存區 (無警示窗)
    progressCache = [];
    saveCache();
    
    console.log("所有內容已清空！");
}

// 初始化時設定今日日期並渲染暫存區
document.addEventListener('DOMContentLoaded', () => {
    if (!document.getElementById("dateInput").value) {
        setToday();
    }
    renderCache();
});
</script>

</body>
</html>
