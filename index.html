<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“˜ æ•™å­¸æ—¥èªŒç”Ÿæˆå™¨ï¼ˆv12-Patch2 - ä½œæ¥­ä¸²æ¥ä¿®å¾©ç‰ˆï¼‰</title>
<style>
/* ç¢ºä¿æ‰‹æ©Ÿç›¸å®¹æ€§åŠç¾è§€ (CSS) */
body { font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background:#f5f7fb;margin:0;padding:12px;color:#222;max-width:520px;margin-left:auto;margin-right:auto;}
h1{text-align:center;font-size:1.5rem;margin:12px 0 14px 0;}
.card{background:#fff;border-radius:12px;padding:12px 10px;margin-bottom:12px;
  box-shadow:0 2px 8px rgba(0,20,50,0.06);}
label{font-weight:600;display:block;margin-top:6px;margin-bottom:2px;}
input,select,textarea{width:100%;padding:8px;border-radius:8px;font-size:1rem;
  border:1px solid #ccc;box-sizing:border-box;margin-top:2px;}
textarea{resize:vertical;font-size:1rem;}
button{background:#2563eb;color:white;border:none;border-radius:8px;padding:9px 12px;
  margin-top:8px;cursor:pointer;font-weight:bold;font-size:1rem;margin-right:6px;}
button.danger{background:#ef4444;}button.green{background:#22c55e;}button.orange{background:#f59e0b;}
.section{border-top:1px solid #e5e7eb;margin-top:8px;padding-top:8px;}
.chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #cbd5e1;
  margin:4px 3px 3px 0;background:#eef3fc;font-size:0.93rem;cursor:pointer;}
.chip:hover{background:#e2e8f0;}
.output{font-family:"Noto Sans Mono","Consolas",monospace;border-radius:8px;
  line-height:1.6;background:#fff;border:1px solid #e5e7eb;padding:14px 12px;margin-top:10px;
  font-size:1.05rem;white-space:pre-wrap;letter-spacing:0.012em;}
@media (max-width:520px){
  body{padding:4px;}
  .output{font-size:1.09rem;padding:8px 6px;}
  input,select,textarea{font-size:1.01rem;}
}

/* 1. ç­ç´šé¸å–®ä¸‰æ ¼æ’ç‰ˆ */
.select-group {
    display: flex;
    gap: 5px;
}
.select-group select {
    width: 33.33%;
    margin-top: 0;
}
.select-group + input {
    margin-top: 5px;
}
/* 3. æŒ‰éˆ•æ’ç‰ˆ */
.button-row {
    display: flex;
    gap: 5px;
    margin-top: 10px;
}
.button-row button {
    margin-top: 0;
    margin-right: 0;
    flex-grow: 1;
    width: auto; /* è®“ flex-grow æ§åˆ¶å¯¬åº¦ */
}

/* æ ¸å–æ–¹å¡Šæ¨£å¼èª¿æ•´ */
.unit-row{
  display: flex; 
  align-items: flex-start; 
  margin-top: 5px;
  line-height: 1.2; 
}
.unit-row input[type=checkbox]{
  width: auto; 
  margin: 2px 5px 0 0; 
  transform: scale(1.1); 
  flex-shrink: 0; 
}
.unit-label{
  flex: 1; 
  display: inline; 
  margin-top: 0;
}

/* æš«å­˜å€æ¨£å¼ */
#progressCache {
    margin-top: 10px;
    border: 1px dashed #2563eb;
    background: #f0f7ff;
    padding: 10px;
    border-radius: 8px;
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.95rem;
}
#progressCache .cache-item {
    margin-bottom: 5px;
    color: #1e40af;
    line-height: 1.3;
}
</style>
</head>
<body>
<h1>ğŸ“˜ æ•™å­¸æ—¥èªŒç”Ÿæˆå™¨ï¼ˆv12-Patch2 - ä½œæ¥­ä¸²æ¥ä¿®å¾©ç‰ˆï¼‰</h1>

<div class="card">
  <label>ğŸ« ç­ç´šæ¨¡æ¿</label>
  <div class="select-group">
    <select id="gradeSelect">
      <option>é«˜ä¸€</option>
      <option>é«˜äºŒ</option>
      <option>é«˜ä¸‰</option>
    </select>
    <select id="subjectSelect">
      <option>ç‰©ç†</option>
      <option>åŒ–å­¸</option>
      <option>ç”Ÿç‰©</option>
      <option>åœ°ç§‘</option>
    </select>
    <select id="classTypeSelect">
      <option>é€²åº¦</option>
      <option>ç¸½è¤‡ç¿’</option>
    </select>
  </div>
  <input id="customClassName" placeholder="æˆ–è‡ªè¨‚ç­ç´šåç¨±ï¼ˆå¯ç©ºç™½ï¼‰">
  <button class="green" onclick="addTemplate()">ï¼‹æ–°å¢æ¨¡æ¿</button>
  <button onclick="fillTemplate()">å¡«å…¥ç­å</button>
  <button class="danger" onclick="clearTemplates()">å…¨æ¸…æ¨¡æ¿</button>
  <div id="templateList" style="margin-top:5px;"></div>
</div>

<div class="card">
  <label>ğŸ—“ï¸ æ—¥æœŸ</label>
  <div style="display:flex;gap:7px;flex-wrap:wrap;">
    <input id="dateInput" placeholder="è‡ªå‹•ä»Šæ—¥">
    <button onclick="setToday()">ä»Šå¤©</button>
    <button onclick="setTomorrow()">æ˜å¤©</button>
  </div>
</div>

<div class="card">
  <label>ğŸ“š ç§‘ç›® / é€²åº¦é¸å–®</label>
  <select id="subject" onchange="loadBooks()">
    <option value="">--é¸ç§‘ç›®--</option>
    <option value="physics">ç‰©ç†</option>
    <option value="chemistry">åŒ–å­¸</option>
    <option value="biology">ç”Ÿç‰©</option>
    <option value="earth">åœ°ç§‘</option>
  </select>
  
  <div id="bookArea" class="section">
    </div>
  
  <div id="cacheArea" class="section" style="text-align: center;">
      <button class="orange" onclick="addToCache()">â¡ï¸ å­˜å…¥æš«å­˜å€</button>
      <button class="danger" onclick="clearCache(true)">ğŸ—‘ï¸ æ¸…ç©ºæš«å­˜</button> 
  </div>
  
  <label style="margin-top: 10px;">ğŸ’¾ å·²é¸é€²åº¦æš«å­˜å€</label>
  <div id="progressCache">ç›®å‰ç„¡æš«å­˜é€²åº¦ã€‚</div>
</div>

<div class="card">
  <div class="section">
    <label>ğŸ“„ é æ•¸</label>
    <input id="pages" placeholder="ä¾‹ï¼šp.45~52">
    <div style="display:flex;gap:5px;flex-wrap:wrap;">
      <span class="chip" onclick="appendPages('p. ')">p. </span>
      <span class="chip" onclick="appendPages('p. 5~8')">p. 5~8</span>
      <span class="chip" onclick="appendPages('p. 10~15')">p. 10~15</span>
      <span class="chip" onclick="appendPages('p. 25~30')">p. 25~30</span>
      <span class="chip" onclick="appendPages('p. 50~55')">p. 50~55</span>
    </div>
  </div>
  <div class="section">
    <label>ğŸ§¾ å°è€ƒ</label>
    <input id="quiz" placeholder="ä¾‹ï¼šç¬¬2ç« å°è€ƒ">
  </div>
  <div class="section">
    <label>ğŸ  å›å®¶ä½œæ¥­</label>
    <textarea id="homework" rows="2" placeholder="ä¾‹ï¼šè¬›ç¾© p.53~55ï¼‹ç¿’é¡Œ"></textarea>
    <div id="sentenceChips"></div>
    <input id="newSentence" placeholder="åŠ åˆ°å¸¸ç”¨ä½œæ¥­å¥åº«ï¼ˆå³éµåˆªï¼‰">
    <button class="green" onclick="addSentence()">ï¼‹å¥åº«</button>
  </div>
</div>

<div class="card">
  <div class="button-row">
    <button class="orange" onclick="generate()">ğŸš€ ç”¢ç”Ÿæ—¥èªŒ</button>
    <button onclick="copyOutput()">ğŸ“‹ è¤‡è£½</button>
    <button class="danger" onclick="clearAll(true)">ğŸ§¹ æ¸…ç©º</button>
  </div>
  <div id="output" class="output" style="display:none"></div>
</div>

<script src="data.js"></script>

<script>
// ================ JS è®Šæ•¸èˆ‡è¼”åŠ©å‡½æ•¸ ================
let progressCache = JSON.parse(localStorage.getItem('teachingLogCache')) || [];

function saveCache() {
    localStorage.setItem('teachingLogCache', JSON.stringify(progressCache));
    renderCache();
}

function renderCache() {
    const cacheDiv = document.getElementById('progressCache');
    if (progressCache.length === 0) {
        cacheDiv.innerHTML = 'ç›®å‰ç„¡æš«å­˜é€²åº¦ã€‚';
        return;
    }

    // å°‡æš«å­˜å€çš„é€²åº¦ä¾è·¯å¾‘é‡æ–°åˆ†çµ„ (å› ç‚ºæš«å­˜æ™‚æ˜¯å–®æ¢å„²å­˜)
    const groupedCache = new Map();
    progressCache.forEach(item => {
        const path = item.path;
        if (groupedCache.has(path)) {
            // é¿å…é‡è¤‡åŠ å…¥ topic
            if (!groupedCache.get(path).includes(item.topic)) {
                 groupedCache.get(path).push(item.topic);
            }
        } else {
            groupedCache.set(path, [item.topic]);
        }
    });

    let html = '';
    groupedCache.forEach((topics, path) => {
        const combinedTopics = topics.join(' ï¼‹ ');
        const pathParts = path.split(' / ');
        const lastPart = pathParts.slice(-1)[0];
        
        // å¦‚æœåªæœ‰ä¸€å€‹ topic ä¸” topic ç­‰æ–¼è·¯å¾‘æœ€å¾Œä¸€éƒ¨åˆ†ï¼ˆç« /ç¯€/å†Šï¼‰ï¼Œå‰‡åªé¡¯ç¤ºè·¯å¾‘
        const isPathOnly = topics.length === 1 && topics[0] === lastPart;
        
        if (isPathOnly) {
             html += `<div class="cache-item">â€§ ${path}</div>`;
        } else {
             html += `<div class="cache-item">â€§ ${path} <br> (${combinedTopics})</div>`;
        }
    });
    
    cacheDiv.innerHTML = html;
}

// ============== æ ¸å¿ƒä¿®æ”¹å€: addToCache() ç§»é™¤å‹¾é¸é™åˆ¶ï¼Œæ”¹ç‚ºåˆ†å±¤ç´šå­˜å…¥ ==============
function addToCache() {
    let itemsToCache = [];
    const checks = document.querySelectorAll("#topicArea input[type=checkbox]:checked");
    
    // 1. å„ªå…ˆè™•ç†æœ‰å‹¾é¸é‡é»çš„æƒ…æ³ (æœ€é«˜å±¤ç´šï¼Œæœ€ç´°ç¯€)
    if (checks.length > 0) {
        checks.forEach(cb => {
            const path = cb.value; 
            const topic = cb.dataset.topicName; 
            itemsToCache.push({ path: path, topic: topic });
            cb.checked = false; // æ¸…ç©ºç•¶å‰é é¢å‹¾é¸ç‹€æ…‹
        });
        console.log(`å·²å°‡ ${checks.length} å€‹å‹¾é¸é‡é»å­˜å…¥æš«å­˜å€ï¼`);
    } else {
        // 2. è™•ç†æ²’æœ‰å‹¾é¸é‡é»ï¼Œä½†é¸å–®æœ‰é¸å–çš„æƒ…æ³
        const subjectSelect = document.getElementById('subject');
        const subjectKey = subjectSelect ? subjectSelect.value : '';
        const subjectName = subjectSelect ? subjectSelect.options[subjectSelect.selectedIndex].text : '';
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const sectionSelect = document.getElementById('sectionSelect');
        
        const bookName = bookSelect ? bookSelect.value : '';
        const chapterName = chapterSelect ? chapterSelect.value : '';
        const sectionName = sectionSelect ? sectionSelect.value : '';

        let progressPath = '';
        let progressName = '';

        if (subjectKey) {
            if (sectionName) {
                // 2.1. é¸åˆ°å°ç¯€: å­˜å…¥ å°ç¯€ åç¨±
                progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
                progressName = sectionName;
                
            } else if (chapterName) {
                // 2.2. é¸åˆ°ç« ç¯€: å­˜å…¥ ç« ç¯€ åç¨±
                progressPath = `${bookName} / ${chapterName}`;
                progressName = chapterName;
                
            } else if (bookName) {
                // 2.3. é¸åˆ°å†Šåˆ¥: å­˜å…¥ å†Šåˆ¥ åç¨±
                progressPath = `${bookName}`;
                progressName = bookName;
                
            } else {
                // 2.4. åªé¸åˆ°ç§‘ç›® (ä¾ç…§ V11 ç¬¬ 5 é»è¦æ±‚ï¼Œç§‘ç›®å¦‚æœåªé¸æ“‡äº† ç‰©ç† å‰‡è¼¸å‡ºç‰©ç†åˆ°æš«å­˜å€)
                // å¼·åŒ–é‚è¼¯ï¼šå¦‚æœåªé¸ç§‘ç›®ï¼Œä¸”è©²ç§‘ç›®æœ‰å†Šåˆ¥ï¼Œå‰‡å°‡æ‰€æœ‰å†Šåˆ¥åç¨±ä½œç‚º pathï¼Œç§‘ç›®åç¨±ä½œç‚º topic å­˜å…¥
                if (BOOKS[subjectKey]) {
                    Object.keys(BOOKS[subjectKey]).forEach(bName => {
                        // é€™è£¡ä½¿ç”¨ å†Šåˆ¥å ä½œç‚º pathï¼Œç§‘ç›®åä½œçˆ² topicï¼Œç¬¦åˆè¼¸å‡ºè¦æ±‚ä½†é¿å…å–®ç´”å­˜å…¥ç§‘ç›®åã€‚
                        itemsToCache.push({ path: bName, topic: subjectName }); 
                    });
                     if (itemsToCache.length > 0) {
                         console.log(`åµæ¸¬åˆ°åªé¸ç§‘ç›®ï¼Œå·²å°‡ ${subjectName} æ¶‰åŠçš„ ${itemsToCache.length} å€‹å†Šåˆ¥ä½œç‚ºé€²åº¦å­˜å…¥æš«å­˜å€ï¼`);
                         
                     }
                    // åŸ·è¡Œå®Œç•¢ï¼Œä¸éœ€å†ç¹¼çºŒ
                    itemsToCache.forEach(item => {
                        const isDuplicate = progressCache.some(p => p.path === item.path && p.topic === item.topic);
                        if (!isDuplicate) progressCache.push(item);
                    });
                    saveCache(); 
                    return; 
                }
            }
        }
        
        // 3. å°‡æœ€é«˜å±¤ç´šçš„é¸æ“‡åŠ å…¥ toCache åˆ—è¡¨
        if (progressPath && progressName) {
            itemsToCache.push({ path: progressPath, topic: progressName });
            console.log(`å·²å°‡é¸å–®æœ€é«˜å±¤ç´šï¼š${progressPath} å­˜å…¥æš«å­˜å€ï¼`);
        }
        
        // 4. å¦‚æœæ²’æœ‰ä»»ä½•é¸å– (åŒ…æ‹¬ç§‘ç›®)ï¼Œå‰‡æç¤º
        if (itemsToCache.length === 0) {
            console.log("è«‹åœ¨ä¸Šæ–¹é¸å–®é¸æ“‡é€²åº¦ï¼Œæˆ–å‹¾é¸é‡é»å–®å…ƒã€‚");
            return;
        }
    }

    // 5. çµ±ä¸€å¯«å…¥æš«å­˜å€
    let addedCount = 0;
    itemsToCache.forEach(item => {
        const isDuplicate = progressCache.some(p => p.path === item.path && p.topic === item.topic);
        if (!isDuplicate) {
            progressCache.push(item);
            addedCount++;
        }
    });

    if (addedCount > 0) {
        saveCache(); // ä¿å­˜ä¸¦é‡æ–°æ¸²æŸ“
        // å¦‚æœæ˜¯å¤šå€‹é‡é»ï¼Œè¨Šæ¯å·²åœ¨å‰é¢è¼¸å‡º
        if (checks.length === 0 && itemsToCache.length === 1) {
             console.log("é€²åº¦å·²å­˜å…¥æš«å­˜å€ã€‚");
        } else if (checks.length === 0 && itemsToCache.length > 1) {
             // è™•ç†åªé¸ç§‘ç›®çš„å¤šå€‹å†Šåˆ¥æƒ…æ³
        } else {
             // è™•ç†å¤šå€‹é‡é»çš„æƒ…æ³
        }
    } else if (checks.length > 0) {
        // æœ‰å‹¾é¸ï¼Œä½†éƒ½é‡è¤‡
         console.log("æ‚¨å‹¾é¸çš„é‡é»å·²å…¨éƒ¨åœ¨æš«å­˜å€ä¸­ã€‚");
    } else {
        // æœ‰é¸å–®é¸é …ï¼Œä½†é‡è¤‡
        console.log("æ‚¨é¸æ“‡çš„é€²åº¦å·²åœ¨æš«å­˜å€ä¸­ã€‚");
    }
}


// å¢åŠ ä¸€å€‹åƒæ•¸ä»¥æ§åˆ¶æ˜¯å¦é¡¯ç¤ºè­¦ç¤ºçª—
function clearCache(showConfirm = false) {
    if (showConfirm) {
        if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æš«å­˜å€çš„é€²åº¦å—ï¼Ÿ")) {
            return;
        }
    }
    progressCache = [];
    saveCache();
    console.log("æš«å­˜å€å·²æ¸…ç©ºï¼");
}

// 2. é æ•¸å¸¸ç”¨é¸é …åŠŸèƒ½
function appendPages(text) {
  const pagesInput = document.getElementById("pages");
  pagesInput.value = text.trim();
}

// ================ ç´šè¯é¸å–®åŠŸèƒ½ (èˆ‡ v11 ç›¸åŒ) ================
function loadBooks() {
    const subjectKey = document.getElementById('subject').value;
    const bookArea = document.getElementById('bookArea');
    bookArea.innerHTML = '';
    
    if (!subjectKey || !BOOKS[subjectKey]) {
        return;
    }

    const books = Object.keys(BOOKS[subjectKey]);
    if (books.length === 0) return;

    let html = '<label>ğŸ“– å†Šåˆ¥</label>';
    html += `<select id="bookSelect" onchange="loadChapters()">
                <option value="">--é¸å†Šåˆ¥--</option>
                ${books.map(b => `<option value="${b}">${b}</option>`).join('')}
             </select>`;
    
    html += '<div id="chapterSelectArea" style="margin-top:10px;"></div>';
    html += '<div id="sectionSelectArea" style="margin-top:10px;"></div>';
    html += '<div id="topicArea" style="margin-top:10px;"></div>';

    bookArea.innerHTML = html;
}

function loadChapters() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const bookName = bookSelect ? bookSelect.value : '';

    const chapterArea = document.getElementById('chapterSelectArea');
    chapterArea.innerHTML = '';
    document.getElementById('sectionSelectArea').innerHTML = '';
    document.getElementById('topicArea').innerHTML = ''; 

    if (!bookName) return;

    const chapters = Object.keys(BOOKS[subjectKey][bookName]);
    
    let html = '<label>ğŸ“‘ ç« ç¯€</label>';
    html += `<select id="chapterSelect" onchange="loadSections()">
                <option value="">--é¸ç« ç¯€--</option>
                ${chapters.map(c => `<option value="${c}">${c}</option>`).join('')}
             </select>`;
    
    chapterArea.innerHTML = html;
}

function loadSections() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const bookName = bookSelect ? bookSelect.value : '';
    const chapterName = chapterSelect ? chapterSelect.value : '';

    const sectionArea = document.getElementById('sectionSelectArea');
    sectionArea.innerHTML = '';
    document.getElementById('topicArea').innerHTML = ''; 
    
    if (!chapterName) return;
    
    const sections = Object.keys(BOOKS[subjectKey][bookName][chapterName]);
    
    let html = '<label>ğŸ“ å°ç¯€</label>';
    html += `<select id="sectionSelect" onchange="loadTopics()">
                <option value="">--é¸å°ç¯€--</option>
                ${sections.map(s => `<option value="${s}">${s}</option>`).join('')}
             </select>`;
    
    sectionArea.innerHTML = html;
}

function loadTopics() {
    const subjectKey = document.getElementById('subject').value;
    const bookSelect = document.getElementById('bookSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const sectionSelect = document.getElementById('sectionSelect');
    
    const bookName = bookSelect ? bookSelect.value : '';
    const chapterName = chapterSelect ? chapterSelect.value : '';
    const sectionName = sectionSelect ? sectionSelect.value : '';
    
    const topicArea = document.getElementById('topicArea');
    topicArea.innerHTML = '';

    if (!sectionName) return;

    const topics = BOOKS[subjectKey][bookName][chapterName][sectionName];

    let html = '<label>âœ… ä»Šæ—¥é€²åº¦ (å¯è¤‡é¸)</label>';
    html += '<div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 8px; border-radius: 8px;">';
    
    topics.forEach((topic, index) => {
        const progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
        const uniqueId = `topic-${sectionName.replace(/\s/g, '_')}-${index}`;
        html += `<div class="unit-row">
                    <input type="checkbox" id="${uniqueId}" value="${progressPath}" data-topic-name="${topic}">
                    <label for="${uniqueId}" class="unit-label">${topic}</label>
                 </div>`;
    });
    
    html += '</div>';
    topicArea.innerHTML = html;
}


function formatDate(date) {
  const d = new Date(date);
  const year = d.getFullYear();
  const month = ('0' + (d.getMonth() + 1)).slice(-2);
  const day = ('0' + d.getDate()).slice(-2);
  return `${year}-${month}-${day}`;
}
function setToday(){
  document.getElementById("dateInput").value = formatDate(new Date());
}
function setTomorrow(){
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById("dateInput").value = formatDate(tomorrow);
}

// ================ æ¨¡æ¿åŠŸèƒ½ (ç§»é™¤è­¦ç¤ºçª—) ================
let templates = JSON.parse(localStorage.getItem('teachingLogTemplates')) || [];
function saveTemplates() { localStorage.setItem('teachingLogTemplates', JSON.stringify(templates)); }
function renderTemplates() {
  const list = document.getElementById("templateList");
  list.innerHTML = templates.map((t, i) => 
    `<span class="chip" onclick="applyTemplate('${t}')" oncontextmenu="deleteTemplate(${i}, true); return false;">${t}</span>`
  ).join('');
}
function addTemplate() {
  const grade = document.getElementById("gradeSelect").value || "";
  const type = document.getElementById("classTypeSelect").value || "";
  const subj = document.getElementById("subjectSelect").value || "";
  const custom = document.getElementById("customClassName").value.trim() || "";
  // ä¿®æ­£çµ„åˆé †åºç‚º ç´šåˆ¥ + ç§‘ç›® + é¡å‹
  const name = custom || `${grade}${subj}${type}`; 
  if (name && !templates.includes(name)) {
    templates.push(name);
    saveTemplates();
    renderTemplates();
  }
}
function applyTemplate(name) {
  document.getElementById("customClassName").value = name;
}
function deleteTemplate(index, showConfirm = false) {
    if (showConfirm) {
        if (!confirm(`ç¢ºå®šåˆªé™¤æ¨¡æ¿ï¼š${templates[index]} å—ï¼Ÿ`)) {
            return;
        }
    }
    templates.splice(index, 1);
    saveTemplates();
    renderTemplates();
    console.log(`æ¨¡æ¿å·²åˆªé™¤ã€‚`);
}
function fillTemplate() {
  const className = (() => {
    const grade = document.getElementById("gradeSelect").value || "";
    const type = document.getElementById("classTypeSelect").value || "";
    const subj = document.getElementById("subjectSelect").value || "";
    const custom = document.getElementById("customClassName").value.trim();
    if (custom) return custom;
    // ä¿®æ­£çµ„åˆé †åºç‚º ç´šåˆ¥ + ç§‘ç›® + é¡å‹
    const combo = grade + subj + type;
    return combo; 
  })();
  document.getElementById("customClassName").value = className;
}
function clearTemplates(showConfirm = false) {
    if (showConfirm) {
        if (!confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç­ç´šæ¨¡æ¿å—ï¼Ÿ")) {
            return;
        }
    }
    templates = [];
    saveTemplates();
    renderTemplates();
    console.log("æ‰€æœ‰ç­ç´šæ¨¡æ¿å·²æ¸…ç©ºã€‚");
}
renderTemplates();

// ================ ä½œæ¥­å¥åº«åŠŸèƒ½ (v12-Patch2: ä¿®æ­£ appendHomework èªæ³•éŒ¯èª¤) ================
let sentences = JSON.parse(localStorage.getItem('homeworkSentences')) || ["è¬›ç¾© p.X~Y", "ç¿’é¡Œå·", "è€ƒå·è¨‚æ­£", "è¤‡ç¿’æŒ‡å®šç¯„åœ"];
function saveSentences() { localStorage.setItem('homeworkSentences', JSON.stringify(sentences)); }
function renderSentences() {
  const list = document.getElementById("sentenceChips");
  list.innerHTML = sentences.map((s, i) => 
    `<span class="chip" onclick="appendHomework('${s}')" oncontextmenu="deleteSentence(${i}, true); return false;">${s}</span>`
  ).join('');
}
function addSentence() {
  const newS = document.getElementById("newSentence").value.trim();
  if (newS && !sentences.includes(newS)) {
    sentences.push(newS);
    saveSentences();
    renderSentences();
    document.getElementById("newSentence").value = '';
  }
}

// *** ä¿®å¾©å¾Œçš„ appendHomework å‡½æ•¸ (V12-Patch2 æ ¸å¿ƒä¿®æ”¹) ***
function appendHomework(s) {
  const homework = document.getElementById("homework");
  if (homework.value.trim() === '') {
    homework.value = s;
  } else if (!homework.value.includes(s)) {
    // ä¿®æ­£äº† homework.endsWith() éŒ¯èª¤ï¼Œç¾åœ¨æ”¹ç‚º homework.value.endsWith()
    homework.value += (homework.value.endsWith('ã€‚') || homework.value.endsWith('ã€') || homework.value.endsWith('ï¼') || homework.value.endsWith('ï¼Ÿ') ? '' : 'ï¼‹') + s;
  }
}
// *************************************************

function deleteSentence(index, showConfirm = false) {
    if (showConfirm) {
        if (!confirm(`ç¢ºå®šåˆªé™¤å¥åº«ï¼š${sentences[index]} å—ï¼Ÿ`)) {
            return;
        }
    }
    sentences.splice(index, 1);
    saveSentences();
    renderSentences();
    console.log("å¥åº«é …ç›®å·²åˆªé™¤ã€‚");
}
renderSentences();

// ================ ç”¢ç”Ÿæ—¥èªŒåŠŸèƒ½ (v12-Patch1 å„ªåŒ–ï¼Œç„¡åŠŸèƒ½è®Šå‹•) ================
function generate() {
    // 1. æŠ“å–æ‰€æœ‰å€¼ä¸¦é€²è¡Œ trim()
    const customClassName = document.getElementById("customClassName").value.trim();
    const date = document.getElementById("dateInput").value.trim();
    const pages = document.getElementById("pages").value.trim();
    const quiz = document.getElementById("quiz").value.trim();
    const homework = document.getElementById("homework").value.trim();
    
    // 1.1. æª¢æŸ¥æ˜¯å¦æœ‰ç•¶å‰é¸ä¸­çš„é‡é»ï¼šè‡ªå‹•å­˜å…¥æš«å­˜å€ (ä¸çµ¦æç¤º)
    const currentChecks = document.querySelectorAll("#topicArea input[type=checkbox]:checked");
    let tempCacheFromChecks = [];
    if (currentChecks.length > 0) {
        console.log(`åµæ¸¬åˆ° ${currentChecks.length} å€‹å‹¾é¸é‡é»ï¼Œè‡ªå‹•å­˜å…¥æš«å­˜å€ã€‚`);
        currentChecks.forEach(cb => {
            const path = cb.value; 
            const topic = cb.dataset.topicName; 
            const newItem = { path: path, topic: topic };
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ (é¿å…é‡è¤‡åŠ å…¥)
            const isDuplicate = progressCache.some(item => item.path === path && item.topic === topic);

            if (!isDuplicate) {
                progressCache.push(newItem);
            }
            cb.checked = false; // æ¸…ç©ºç•¶å‰é é¢å‹¾é¸ç‹€æ…‹
        });
        saveCache(); // ä¿å­˜ä¸¦é‡æ–°æ¸²æŸ“æš«å­˜å€
    }

    const className = (() => {
        if (customClassName) return customClassName;
        const grade = document.getElementById("gradeSelect").value || "";
        const type = document.getElementById("classTypeSelect").value || "";
        const subj = document.getElementById("subjectSelect").value || "";
        // ä¿®æ­£çµ„åˆé †åºç‚º ç´šåˆ¥ + ç§‘ç›® + é¡å‹
        const combo = grade + subj + type;
        return combo.trim();
    })(); 

    // 2. è™•ç†é€²åº¦ï¼šå„ªå…ˆä½¿ç”¨æš«å­˜å€ (progressCache) ä¸­çš„æ•¸æ“š
    
    let progressToOutput = []; // å„²å­˜æœ€çµ‚è¦è¼¸å‡ºçš„é€²åº¦é …ç›®
    
    if (progressCache.length > 0) {
        // 2.1. A. æš«å­˜å€æœ‰è³‡æ–™ï¼šä½¿ç”¨æš«å­˜å€ (progressCache)
        progressToOutput = [...progressCache]; // è¤‡è£½ä¸€ä»½ï¼Œé¿å…ç›´æ¥ä¿®æ”¹
        console.log("é€²åº¦ä¾†æºï¼šæš«å­˜å€");
    } else {
        // 2.1. B. æš«å­˜å€ç„¡è³‡æ–™ï¼šå˜—è©¦å¾é¸å–®ä¸­æŠ“å–æœ€é«˜å±¤ç´šé€²åº¦ (åŒ addToCache é‚è¼¯ï¼Œé¿å…é‡è¤‡)
        const subjectSelect = document.getElementById('subject');
        const subjectKey = subjectSelect ? subjectSelect.value : '';
        const subjectName = subjectSelect ? subjectSelect.options[subjectSelect.selectedIndex].text : '';
        const bookSelect = document.getElementById('bookSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const sectionSelect = document.getElementById('sectionSelect');
        
        const bookName = bookSelect ? bookSelect.value : '';
        const chapterName = chapterSelect ? chapterSelect.value : '';
        const sectionName = sectionSelect ? sectionSelect.value : '';

        let progressPath = '';
        let progressName = '';

        if (sectionName) {
            // é¸åˆ°å°ç¯€ (æœ€é«˜å±¤ç´šï¼šå°ç¯€)
            progressPath = `${bookName} / ${chapterName} / ${sectionName}`;
            progressName = sectionName;
            
        } else if (chapterName) {
            // åªé¸åˆ°ç« ç¯€ (æœ€é«˜å±¤ç´šï¼šç« ç¯€)
            progressPath = `${bookName} / ${chapterName}`;
            progressName = chapterName;
            
        } else if (bookName) {
            // åªé¸åˆ°å†Šåˆ¥ (æœ€é«˜å±¤ç´šï¼šå†Šåˆ¥)
            progressPath = `${bookName}`;
            progressName = bookName;
            
        } else if (subjectKey) {
            // åªé¸ç§‘ç›®: è¼¸å‡ºç§‘ç›®åç¨±
            // ç”±æ–¼é€™æ™‚æ²’æœ‰æ˜ç¢ºçš„ pathï¼Œç‚ºäº†è¼¸å‡ºï¼Œæˆ‘å€‘å–æ‰€æœ‰å†Šåˆ¥ä½œç‚º pathï¼Œç§‘ç›®åä½œç‚º topic
            if (BOOKS[subjectKey]) {
                Object.keys(BOOKS[subjectKey]).forEach(bName => {
                     progressToOutput.push({ path: bName, topic: subjectName }); 
                });
            }
            console.log("é€²åº¦ä¾†æºï¼šé¸å–® (åªé¸ç§‘ç›®)");
        }
        
        // å°‡æœ€é«˜å±¤ç´šçš„å–®ä¸€é¸æ“‡åŠ å…¥ output åˆ—è¡¨
        if (progressPath && progressName) {
             progressToOutput.push({ path: progressPath, topic: progressName });
             console.log("é€²åº¦ä¾†æºï¼šé¸å–® (æœ€é«˜å±¤ç´š)");
        }
        
    }
    
    // 2.2. å°‡é€²åº¦ä¾è·¯å¾‘é‡æ–°åˆ†çµ„ (ä¸è«–ä¾†æºæ˜¯æš«å­˜å€é‚„æ˜¯è‡ªå‹•æŠ“å–)
    const groupedProgress = new Map();
    progressToOutput.forEach(item => {
      const path = item.path;
      const topic = item.topic || path.split(' / ').pop(); // å¦‚æœæ²’æœ‰ topicï¼Œä½¿ç”¨è·¯å¾‘çš„æœ€å¾Œä¸€éƒ¨åˆ†
      
      if (groupedProgress.has(path)) {
        if (!groupedProgress.get(path).includes(topic)) {
             groupedProgress.get(path).push(topic);
        }
      } else {
        groupedProgress.set(path, [topic]);
      }
    });

    const progressLines = [];
    
    // 2.3. éæ­· Map è¼¸å‡ºï¼Œä½¿ç”¨ç·Šæ¹Šæ ¼å¼
    groupedProgress.forEach((topics, path) => {
      // è¼¸å‡ºæ ¼å¼: â€§ å†Šåˆ¥ / ç« ç¯€ / å°ç¯€ (é‡é»1 ï¼‹ é‡é»2)
      const combinedTopics = topics.join(' ï¼‹ ');
      const parts = path.split(' / ');
      const lastPart = parts.slice(-1)[0];
      
      // åˆ¤æ–·æ˜¯å¦ç‚ºã€Œå–®ä¸€ã€é€²åº¦ï¼Œä¸”é‡é»åç¨±èˆ‡è·¯å¾‘æœ«ç«¯åç¨±ç›¸åŒ (æˆ–ç‚ºåªé¸ç§‘ç›®çš„æƒ…æ³)
      const isSingleMatch = (topics.length === 1 && (topics[0] === lastPart || topics[0] === document.getElementById('subject').options[document.getElementById('subject').selectedIndex].text));

      if (isSingleMatch) {
         progressLines.push(`â€§ ${path}`);
      } else {
         progressLines.push(`â€§ ${path} (${combinedTopics})`);
      }
      
    });

    const progressOutput = progressLines.join('\n');


    // 3. çµ„åˆæœ€çµ‚çµæœ (ç©ºå€¼å®Œå…¨ä¸é¡¯ç¤ºå€å¡Šï¼Œå€å¡Šé–“åªæœ‰ä¸€å€‹æ›è¡Œç¬¦)
    let result = [];

    // ç­ç´š
    if (className) {
        result.push(`ğŸ« ç­ç´š\n${className}`);
    }

    // æ—¥æœŸ
    if (date) {
        result.push(`ğŸ—“ï¸ æ—¥æœŸ\n${date}`);
    }

    // é€²åº¦ (å¾æš«å­˜å€æˆ–é¸å–®å–å‡ºï¼Œå¯ç©º)
    if (progressOutput) {
        result.push(`ğŸ“˜ ä»Šæ—¥é€²åº¦\n${progressOutput}`);
    }

    // é æ•¸
    if (pages) {
        result.push(`ğŸ“„ é æ•¸\n${pages}`);
    }

    // å°è€ƒ
    if (quiz) {
        result.push(`ğŸ§¾ å°è€ƒ\n${quiz}`);
    }

    // ä½œæ¥­
    if (homework) {
        result.push(`ğŸ  ä½œæ¥­\n${homework}`);
    }
    
    // 4. è¼¸å‡º
    const out = document.getElementById("output");
    out.style.display="block";
    // ä½¿ç”¨ \n åˆ†éš”æ¯å€‹å€å¡Š (å¯¦ç¾å€å¡Šé–“ç„¡ç©ºè¡Œ)
    out.textContent = result.join('\n').trim(); 
    out.scrollIntoView({behavior:"smooth"});
    
    // ç”¢ç”Ÿå¾Œæ¸…ç©ºæš«å­˜å€
    if (progressCache.length > 0) {
        // åªè¦ä½¿ç”¨äº†æš«å­˜å€çš„å…§å®¹ï¼Œå°±æ¸…ç©º
        progressCache = [];
        saveCache(); // æ¸…ç©ºä¸¦ä¿å­˜
    }
}


function copyOutput(){
    const text=document.getElementById("output").textContent;
    if(!text) {
        console.log("è«‹å…ˆç”¢ç”Ÿå…§å®¹");
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        console.log("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"); // ä½¿ç”¨ console.log æ›¿ä»£ alert
    }).catch(err => {
        console.error('è¤‡è£½å¤±æ•—:', err);
    });
}

// å¢åŠ ä¸€å€‹åƒæ•¸ä»¥æ§åˆ¶æ˜¯å¦é¡¯ç¤ºè­¦ç¤ºçª—
function clearAll(showConfirm = false){
    if (showConfirm) {
        if (!confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¡†å…§å®¹èˆ‡æš«å­˜å€å—ï¼Ÿ")) {
            return;
        }
    }
    document.getElementById("dateInput").value = "";
    document.getElementById("bookArea").innerHTML = ""; 
    document.getElementById("pages").value = "";
    document.getElementById("quiz").value = "";
    document.getElementById("homework").value = "";
    document.getElementById("customClassName").value = "";
    document.getElementById("output").textContent = "";
    document.getElementById("output").style.display="none";
    
    // æ¸…ç©ºæš«å­˜å€ (ç„¡è­¦ç¤ºçª—)
    progressCache = [];
    saveCache();
    
    console.log("æ‰€æœ‰å…§å®¹å·²æ¸…ç©ºï¼");
}

// åˆå§‹åŒ–æ™‚è¨­å®šä»Šæ—¥æ—¥æœŸä¸¦æ¸²æŸ“æš«å­˜å€
document.addEventListener('DOMContentLoaded', () => {
    if (!document.getElementById("dateInput").value) {
        setToday();
    }
    renderCache();
});
</script>

</body>
</html>